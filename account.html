<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Your Braga Bazaar account. Profile, order history, and settings." />
  <title>My Account | Braga Bazaar</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    :root{
      --green:#2d7a32;
      --slate:#1e293b;
      --muted:#64748b;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --shadow:0 10px 30px rgba(15,23,42,0.08);
      --radius:20px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); font-family:'Inter',system-ui,-apple-system,sans-serif; color:var(--slate); }
    a{ color:inherit; }

    .page-wrap{ max-width: 980px; margin: 28px auto; padding: 0 16px; }

    /* Top nav + lang */
    .topbar{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
      margin-bottom:18px;
    }
    .nav{
      display:flex; align-items:center; gap:16px; flex-wrap:wrap;
    }
    .brand{
      font-weight:900; text-decoration:none; color:#333; letter-spacing:0.2px;
    }
    .brand span{ color:var(--green); }
    .nav a{
      color:var(--muted); text-decoration:none; font-weight:700; font-size:0.92rem;
      padding:8px 10px; border-radius:12px;
    }
    .nav a:hover{ background:#f1f5f9; color:var(--slate); }
    .nav .active{
      color:var(--green); font-weight:900; background:rgba(45,122,50,0.08);
      padding:8px 10px; border-radius:12px;
    }

    .lang-bar{ display:flex; gap:10px; }
    .lang-btn{
      background:#fff; border:1px solid #cbd5e1; padding:6px 12px; border-radius:999px;
      cursor:pointer; font-size:0.82rem; font-weight:900;
    }
    .lang-btn.active{ background:var(--slate); color:#fff; border-color:var(--slate); }

    /* Layout */
    .grid-layout{ display:grid; grid-template-columns: 340px 1fr; gap: 18px; }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }
    .card h2{
      color:var(--green);
      font-size:1.15rem;
      margin:0 0 14px 0;
      display:flex; align-items:center; gap:10px;
    }

    /* Form */
    .form-group{ margin-bottom: 14px; }
    .form-group label{
      display:block; font-weight:800; font-size:0.78rem;
      color:var(--muted); margin-bottom:6px;
    }
    .form-group input{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
    }
    .form-group input:focus{
      border-color:#94a3b8;
      box-shadow:0 0 0 4px rgba(148,163,184,0.18);
    }

    /* Buttons */
    .btn{
      border:none; border-radius:12px; padding:12px 16px;
      font-weight:900; cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition:0.15s ease; text-decoration:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-green{ background:var(--green); color:#fff; }
    .btn-green:hover{ filter:brightness(0.95); }
    .btn-outline{
      background:#fff; color:var(--green); border:2px solid var(--green);
    }
    .btn-red{ background:#dc2626; color:#fff; }
    .btn-red:hover{ background:#b91c1c; }
    .btn-gray{
      background:#f1f5f9; color:#0f172a; border:1px solid var(--border);
    }
    .btn-small{ padding:8px 12px; border-radius:10px; font-size:0.86rem; font-weight:900; }

    /* Orders */
    .orders-head{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
      margin-bottom:10px;
    }
    .orders-table-wrap{ width:100%; overflow:auto; border:1px solid var(--border); border-radius:14px; }
    .order-table{ width:100%; border-collapse:collapse; font-size:0.92rem; min-width: 560px; background:#fff; }
    .order-table th{
      text-align:left; padding:12px;
      border-bottom:1px solid var(--border);
      color:var(--muted); font-size:0.74rem; text-transform:uppercase; letter-spacing:0.06em;
      background:#f8fafc;
      position:sticky; top:0;
    }
    .order-table td{ padding:12px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
    .order-table tr:hover td{ background:#fbfdff; }

    /* Badges */
    .badge{
      padding:6px 10px; border-radius:999px; font-size:0.72rem;
      font-weight:900; text-transform:uppercase; display:inline-flex; align-items:center;
    }
    .status-pending{ background:#fef3c7; color:#92400e; }
    .status-shipped{ background:#e0f2fe; color:#075985; }
    .status-delivered{ background:#dcfce7; color:#166534; }

    .hint{ color:var(--muted); font-size:0.88rem; margin:0; }

    /* Responsive */
    @media (max-width: 900px){
      .grid-layout{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="page-wrap">

    <div class="topbar">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">BRAGA<span>BAZAAR</span></a>
        <a href="index.html" data-en="Shopping" data-pt="Loja">Loja</a>
        <a href="orders.html" data-en="Order history" data-pt="As minhas encomendas">As minhas encomendas</a>
        <span class="active" data-en="My account" data-pt="O meu perfil">O meu perfil</span>
      </nav>

      <div class="lang-bar">
        <button id="btn-pt" class="lang-btn active" type="button">PT</button>
        <button id="btn-en" class="lang-btn" type="button">EN</button>
      </div>
    </div>

    <!-- Signed out -->
    <div id="signedOutView" class="card" style="display:none; max-width:520px; margin:0 auto;">
      <h2><i class="fas fa-lock"></i> <span data-en="Sign in to your account" data-pt="Entre na sua conta">Entre na sua conta</span></h2>
      <p class="hint" style="margin-bottom:16px;"
         data-en="Sign in to view your profile, order history, payment methods and account settings."
         data-pt="Entre para ver o seu perfil, histórico de encomendas, métodos de pagamento e definições da conta.">
        Entre para ver o seu perfil, histórico de encomendas, métodos de pagamento e definições da conta.
      </p>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <a href="login.html?redirect=account.html" class="btn btn-green" data-en="Log in" data-pt="Entrar">Entrar</a>
        <a href="signup.html?redirect=account.html" class="btn btn-outline" data-en="Create account" data-pt="Criar conta">Criar conta</a>
      </div>
    </div>

    <!-- Signed in -->
    <div id="signedInView" style="display:none;">
      <div class="grid-layout">
        <!-- Profile -->
        <div class="card">
          <h2><i class="fas fa-user-circle"></i> <span data-en="Profile Settings" data-pt="Dados da Conta">Dados da Conta</span></h2>
          <form id="accountForm">
            <div class="form-group">
              <label data-en="Email" data-pt="Email">Email</label>
              <input type="email" id="email" readonly style="background:#f1f5f9; cursor:not-allowed;" />
            </div>
            <div class="form-group">
              <label data-en="Full Name" data-pt="Nome Completo">Nome Completo</label>
              <input type="text" id="fullName" required />
            </div>
            <div class="form-group">
              <label data-en="Phone (for tracking)" data-pt="Telemóvel (para tracking)">Telemóvel</label>
              <input type="tel" id="phone" required inputmode="tel" autocomplete="tel" />
            </div>
            <div class="form-group">
              <label data-en="Address" data-pt="Morada">Morada</label>
              <input type="text" id="address" required autocomplete="street-address" />
            </div>
            <div class="form-group">
              <label data-en="Postal code" data-pt="Código postal">Código postal</label>
              <input type="text" id="postal" placeholder="4700-000" autocomplete="postal-code" />
            </div>
            <div class="form-group">
              <label data-en="City" data-pt="Cidade">Cidade</label>
              <input type="text" id="city" placeholder="Braga" autocomplete="address-level2" />
            </div>
            <div class="form-group">
              <label data-en="Country" data-pt="País">País</label>
              <input type="text" id="country" value="Portugal" autocomplete="country-name" />
            </div>

            <button type="submit" class="btn btn-green">
              <i class="fas fa-floppy-disk"></i>
              <span data-en="Update Info" data-pt="Atualizar Dados">Atualizar Dados</span>
            </button>
            <button type="button" id="signOutBtn" class="btn btn-outline" style="margin-left:10px; margin-top:8px;">
              <i class="fas fa-right-from-bracket"></i>
              <span data-en="Sign out" data-pt="Terminar sessão">Terminar sessão</span>
            </button>
            <p class="hint" style="margin-top:10px;"
               data-en="These details are saved on this device. For full sync, store profiles in Supabase."
               data-pt="Estes dados ficam guardados neste dispositivo. Para sincronizar, guarde o perfil na Supabase.">
              Estes dados ficam guardados neste dispositivo. Para sincronizar, guarde o perfil na Supabase.
            </p>
          </form>
        </div>

        <!-- Orders preview -->
        <div class="card">
          <div class="orders-head">
            <h2 style="margin:0;"><i class="fas fa-shopping-bag"></i> <span data-en="Order History" data-pt="Histórico de Encomendas">Histórico de Encomendas</span></h2>
            <a href="orders.html" class="btn btn-gray btn-small" style="text-decoration:none;">
              <span data-en="View all" data-pt="Ver tudo">Ver tudo</span> <i class="fas fa-chevron-right" style="font-size:0.78rem;"></i>
            </a>
          </div>

          <div id="ordersLoading" style="text-align:center; padding:18px; color:var(--muted); font-weight:800;">
            <i class="fas fa-spinner fa-spin"></i> <span data-en="Loading..." data-pt="A carregar...">A carregar...</span>
          </div>

          <div id="ordersError" style="display:none; text-align:center; padding:16px; color:#dc2626; font-weight:900;"></div>

          <div class="orders-table-wrap" id="ordersWrap" style="display:none;">
            <table class="order-table" id="ordersTable">
              <thead>
                <tr>
                  <th data-en="Date" data-pt="Data">Data</th>
                  <th data-en="Total" data-pt="Total">Total</th>
                  <th data-en="Status" data-pt="Estado">Estado</th>
                  <th data-en="Payment" data-pt="Pagamento">Pagamento</th>
                  <th data-en="Action" data-pt="Ação">Ação</th>
                </tr>
              </thead>
              <tbody id="ordersTbody"></tbody>
            </table>
          </div>

          <div id="noOrders" style="display:none; text-align:center; padding:18px; color:var(--muted); font-weight:800;"
               data-en="No orders found." data-pt="Nenhuma encomenda encontrada.">
            Nenhuma encomenda encontrada.
          </div>
        </div>
      </div>

      <div class="grid-layout" style="margin-top:18px;">
        <!-- Payment -->
        <div class="card">
          <h2><i class="fas fa-credit-card"></i> <span data-en="Payment method" data-pt="Método de pagamento">Método de pagamento</span></h2>
          <p id="paymentMethodSummary" class="hint"
             data-en="No saved payment method." data-pt="Nenhum método de pagamento guardado.">
            Nenhum método de pagamento guardado.
          </p>
          <p class="hint" style="margin-top:10px; color:#94a3b8;"
             data-en="You can pay with MB Way, card or cash at checkout."
             data-pt="Pode pagar com MB Way, cartão ou dinheiro no checkout.">
            Pode pagar com MB Way, cartão ou dinheiro no checkout.
          </p>
        </div>

        <!-- Delete -->
        <div class="card">
          <h2><i class="fas fa-user-slash"></i> <span data-en="Account termination" data-pt="Encerrar conta">Encerrar conta</span></h2>
          <p class="hint"
             data-en="This clears saved data on this device and signs you out. If you want true deletion, you must delete the user server-side."
             data-pt="Isto apaga os dados guardados neste dispositivo e termina a sessão. Para eliminar mesmo, tem de apagar o utilizador no servidor.">
            Isto apaga os dados guardados neste dispositivo e termina a sessão. Para eliminar mesmo, tem de apagar o utilizador no servidor.
          </p>
          <button type="button" id="terminateAccountBtn" class="btn btn-red" style="margin-top:12px;">
            <i class="fas fa-trash-can"></i>
            <span data-en="Delete my account" data-pt="Eliminar a minha conta">Eliminar a minha conta</span>
          </button>
        </div>
      </div>
    </div>

    <div style="margin-top:22px; text-align:center;">
      <a href="index.html" style="color:var(--green); text-decoration:none; font-weight:900;">
        <i class="fas fa-chevron-left"></i> <span data-en="Back to Shop" data-pt="Voltar à Loja">Voltar à Loja</span>
      </a>
    </div>
  </div>

  <script type="module">
    import { supabase, ADMIN_ONLY_EMAILS } from './supabaseConfig.js';

    const { data: { session } } = await supabase.auth.getSession();
    const email = (session?.user?.email || '').toLowerCase();
    if (session && Array.isArray(ADMIN_ONLY_EMAILS) && ADMIN_ONLY_EMAILS.some(e => (e || '').toLowerCase() === email)) {
      window.location.href = 'admin.html';
    }

    // ====== Robust login detection (fix) ======
    async function getSessionLogin(){
      try{
        const { data: { session } } = await supabase.auth.getSession();
        return session || null;
      }catch{
        return null;
      }
    }

    // ====== Language toggle (fix: handles placeholders too) ======
    function setLang(lang){
      localStorage.setItem('preferredLang', lang);

      document.querySelectorAll('[data-en]').forEach(el => {
        const txt = el.getAttribute(`data-${lang}`);
        if (txt) el.textContent = txt;
      });

      // also translate placeholders if present
      document.querySelectorAll('[data-ph-en]').forEach(el => {
        const ph = el.getAttribute(`data-ph-${lang}`);
        if (ph) el.setAttribute('placeholder', ph);
      });

      document.getElementById('btn-pt')?.classList.toggle('active', lang === 'pt');
      document.getElementById('btn-en')?.classList.toggle('active', lang === 'en');
    }

    document.getElementById('btn-pt').addEventListener('click', () => setLang('pt'));
    document.getElementById('btn-en').addEventListener('click', () => setLang('en'));
    setLang(localStorage.getItem('preferredLang') || 'pt');

    // ====== Helpers ======
    function normalizeStatus(s){
      const v = (s || 'pending').toString().toLowerCase().trim().replace(/\s+/g, '_');
      if (v === 'delivered') return 'delivered';
      if (v === 'shipped') return 'shipped';
      return 'pending';
    }

    function paymentLabel(p){
      if (!p) return '—';
      const v = (p || '').toString().toLowerCase().trim();
      if (v === 'mb_way' || v === 'mb way') return 'MB Way';
      if (v === 'card' || v === 'cartao' || v === 'cartão') return 'Cartão';
      if (v === 'cash' || v === 'dinheiro') return 'Dinheiro';
      return p;
    }

    function safeNum(n){
      const x = Number(n);
      return Number.isFinite(x) ? x : 0;
    }

    function toast(msg){
      let t = document.getElementById('bbToast');
      if (!t){
        t = document.createElement('div');
        t.id = 'bbToast';
        t.style.cssText =
          'position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(80px);' +
          'background:#1e293b;color:#fff;padding:12px 16px;border-radius:14px;font-weight:900;z-index:9999;' +
          'box-shadow:0 12px 30px rgba(0,0,0,0.35);opacity:0;transition:0.25s ease;max-width:92vw;text-align:center;';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = '1';
      t.style.transform = 'translateX(-50%) translateY(0)';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        t.style.opacity = '0';
        t.style.transform = 'translateX(-50%) translateY(80px)';
      }, 1600);
    }

    // ====== Views ======
    const signedOutView = document.getElementById('signedOutView');
    const signedInView = document.getElementById('signedInView');

    // Local profile (device)
    const localUser = JSON.parse(localStorage.getItem('bragaBazaarUser') || '{}');

    // ====== Reorder (fix: use product_id when available, avoid name+price collisions) ======
    async function reorderOrder(orderId){
      if (!orderId) return;

      const lang = localStorage.getItem('preferredLang') || 'pt';
      const cart = JSON.parse(localStorage.getItem('bragaBazaarCart') || '[]');

      const addItemsToCart = (items) => {
        items.forEach(it => {
          const qty = safeNum(it.qty ?? it.quantity ?? 1) || 1;
          const price = safeNum(it.price ?? it.unit_price ?? 0);
          const key = it.product_id ? String(it.product_id) : `${it.name || it.product_name || 'item'}::${price}`;

          const existing = cart.find(x => (x.product_id ? String(x.product_id) : `${x.name}::${x.price}`) === key);
          if (existing) existing.qty = safeNum(existing.qty) + qty;
          else cart.push({
            product_id: it.product_id || null,
            name: it.name || it.product_name || it.title || 'Item',
            price,
            qty
          });
        });

        localStorage.setItem('bragaBazaarCart', JSON.stringify(cart));
      };

      // local order
      if (String(orderId).startsWith('local-')){
        const localId = Number(String(orderId).replace('local-', ''));
        const localOrders = JSON.parse(localStorage.getItem('bragaBazaarOrders') || '[]');
        const order = localOrders.find(o => o.id === localId);
        if (!order?.items?.length){
          alert(lang === 'en' ? 'Could not load order items.' : 'Não foi possível carregar os artigos da encomenda.');
          return;
        }
        addItemsToCart(order.items);
        alert(lang === 'en' ? 'Items added to cart. Going to shop.' : 'Artigos adicionados ao carrinho. A ir para a loja.');
        window.location.href = 'index.html';
        return;
      }

      // supabase order_items
      const { data: items, error } = await supabase
        .from('order_items')
        .select('product_id, name, price, qty')
        .eq('order_id', orderId);

      if (error || !items?.length){
        alert(lang === 'en' ? 'Could not load order items.' : 'Não foi possível carregar os artigos da encomenda.');
        return;
      }

      addItemsToCart(items);
      alert(lang === 'en' ? 'Items added to cart. Going to shop.' : 'Artigos adicionados ao carrinho. A ir para a loja.');
      window.location.href = 'index.html';
    }

    // ====== Orders fetch (fix: status class normalized, better errors, table wrapper) ======
    async function fetchMyOrders(userProfile){
      const loadingEl = document.getElementById('ordersLoading');
      const wrapEl = document.getElementById('ordersWrap');
      const errorEl = document.getElementById('ordersError');
      const noOrdersEl = document.getElementById('noOrders');
      const tbody = document.getElementById('ordersTbody');

      loadingEl.style.display = 'block';
      wrapEl.style.display = 'none';
      errorEl.style.display = 'none';
      noOrdersEl.style.display = 'none';
      tbody.innerHTML = '';

      const phone = (userProfile.phone || '').trim();
      const email = (userProfile.email || '').trim();

      if (!phone && !email){
        loadingEl.style.display = 'none';
        noOrdersEl.style.display = 'block';
        return;
      }

      // Supabase orders
      let query = supabase.from('orders').select('*').order('created_at', { ascending: false });
      if (phone) query = query.eq('phone', phone);
      else query = query.eq('email', email);

      const { data: supabaseOrders, error } = await query;

      // Local orders merge
      const seenClientIds = new Set((supabaseOrders || []).map(o => o.client_order_id).filter(Boolean));
      const localOrders = JSON.parse(localStorage.getItem('bragaBazaarOrders') || '[]');

      const matchesUser = (o) => {
        const c = o.customer || {};
        const cPhone = (c.phone || '').trim();
        const cEmail = (c.email || '').trim().toLowerCase();
        return (phone && cPhone === phone) || (email && cEmail === email.toLowerCase());
      };

      const localMerged = localOrders
        .filter(o => matchesUser(o) && !seenClientIds.has(o.id))
        .map(o => ({
          id: 'local-' + o.id,
          client_order_id: o.id,
          created_at: o.createdAt,
          total: o.total,
          status: 'pending',
          payment: o.payment || null
        }));

      const allOrders = [...(supabaseOrders || []), ...localMerged];

      // Show error but still show local if available
      if (error){
        errorEl.style.display = 'block';
        errorEl.textContent = 'Erro ao carregar encomendas (a mostrar histórico local, se existir).';
      }

      // Sort: active first, then newest
      const isDelivered = (o) => normalizeStatus(o.status) === 'delivered';
      const orders = allOrders.sort((a, b) => {
        const aLive = !isDelivered(a);
        const bLive = !isDelivered(b);
        if (aLive !== bLive) return aLive ? -1 : 1;
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      });

      loadingEl.style.display = 'none';

      if (!orders.length){
        noOrdersEl.style.display = 'block';
        return;
      }

      const lang = localStorage.getItem('preferredLang') || 'pt';
      const reorderLabel = lang === 'en' ? 'Reorder' : 'Encomendar de novo';

      wrapEl.style.display = 'block';
      tbody.innerHTML = orders.map(o => {
        const status = normalizeStatus(o.status);
        const total = safeNum(o.total || o.total_price || 0).toFixed(2);
        const pay = paymentLabel(o.payment || o.payment_method);
        const date = o.created_at ? new Date(o.created_at).toLocaleDateString() : '—';

        return `
          <tr>
            <td>${date}</td>
            <td style="font-weight:900;">€${total}</td>
            <td><span class="badge status-${status}">${status}</span></td>
            <td>${pay}</td>
            <td>
              <button type="button" class="btn btn-green btn-small reorder-btn" data-order-id="${o.id}">
                <i class="fas fa-rotate"></i> ${reorderLabel}
              </button>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('.reorder-btn').forEach(btn => {
        btn.addEventListener('click', () => reorderOrder(btn.getAttribute('data-order-id')));
      });
    }

    // ====== Profile load/save (fix: validates & doesn’t force reload) ======
    function fillProfile(profile){
      document.getElementById('email').value = profile.email || '';
      document.getElementById('fullName').value = profile.fullName || '';
      document.getElementById('phone').value = profile.phone || '';
      document.getElementById('address').value = profile.address || '';
      document.getElementById('postal').value = profile.postal || '';
      document.getElementById('city').value = profile.city || '';
      document.getElementById('country').value = profile.country || 'Portugal';
    }

    function saveProfile(){
      const updated = {
        ...localUser,
        email: localUser.email || document.getElementById('email').value.trim(),
        fullName: document.getElementById('fullName').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        postal: document.getElementById('postal').value.trim(),
        city: document.getElementById('city').value.trim(),
        country: document.getElementById('country').value.trim()
      };

      // basic validation
      if (!updated.fullName || !updated.phone || !updated.address){
        const lang = localStorage.getItem('preferredLang') || 'pt';
        alert(lang === 'en' ? 'Please fill in name, phone and address.' : 'Por favor preencha nome, telemóvel e morada.');
        return null;
      }

      localStorage.setItem('bragaBazaarUser', JSON.stringify(updated));
      return updated;
    }

    // ====== Sign out (just end session, keep local profile for next login) ======
    async function signOut(){
      try { await supabase.auth.signOut(); } catch (e) { console.warn('signOut:', e); }
      localStorage.removeItem('userIsLoggedIn');
      window.location.href = 'account.html';
    }

    // ====== Termination (fix: clarifies what it does) ======
    async function terminateAccount(){
      const lang = localStorage.getItem('preferredLang') || 'pt';
      const msg = lang === 'en'
        ? 'This will clear saved data on this device and sign you out. Continue?'
        : 'Isto vai apagar os dados guardados neste dispositivo e terminar a sessão. Continuar?';

      if (!confirm(msg)) return;

      localStorage.removeItem('userIsLoggedIn');
      localStorage.removeItem('bragaBazaarUser');
      // optional: clear cart too
      // localStorage.removeItem('bragaBazaarCart');

      try{ await supabase.auth.signOut(); }catch{}
      window.location.href = 'index.html';
    }

    // ====== Boot ======
    (async function init(){
      const session = await getSessionLogin();

      // If you want localStorage login to still work, keep this fallback:
      const localLoggedIn = localStorage.getItem('userIsLoggedIn') === 'true';

      const loggedIn = !!session || localLoggedIn;

      if (loggedIn){
        signedInView.style.display = 'block';
        signedOutView.style.display = 'none';

        // Prefer session email if available
        const profile = {
          ...localUser,
          email: (session?.user?.email || localUser.email || '').trim()
        };

        fillProfile(profile);

        // Save handler
        const form = document.getElementById('accountForm');
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const updated = saveProfile();
          if (!updated) return;
          const lang = localStorage.getItem('preferredLang') || 'pt';
          toast(lang === 'en' ? 'Settings saved.' : 'Dados guardados.');
          // refresh orders with latest phone/email changes
          fetchMyOrders(updated);
        });

        // Sign out
        const signOutBtn = document.getElementById('signOutBtn');
        if (signOutBtn) signOutBtn.addEventListener('click', signOut);

        // Terminate
        document.getElementById('terminateAccountBtn').addEventListener('click', terminateAccount);

        // Orders
        await fetchMyOrders(profile);

      } else {
        signedOutView.style.display = 'block';
        signedInView.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
