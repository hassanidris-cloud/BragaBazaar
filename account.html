<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My account | Braga Bazaar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style type="text/css">.main-header .site-nav a.site-nav-icon-only,.main-header .site-nav a.site-nav-icon-only i,.main-header .site-nav a.site-nav-icon-only .site-nav-cart-total{color:#000!important}.main-header .site-nav a.site-nav-icon-only:link,.main-header .site-nav a.site-nav-icon-only:visited,.main-header .site-nav a.site-nav-icon-only:hover,.main-header .site-nav a.site-nav-icon-only:focus{color:#000!important}.main-header .site-nav a.site-nav-icon-only:hover i,.main-header .site-nav a.site-nav-icon-only:focus i{color:#000!important}</style>
    <style>
        body { background: #f8f9fa; }
        .lang-bar { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 20px; }
        .lang-bar button { background: none; border: 1px solid #4a6d1a; color: #4a6d1a; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 600; }
        .lang-bar button.active { background: #4a6d1a; color: #fff; }
        .page-wrap { max-width: 480px; margin: 40px auto; padding: 0 20px; }
        .card { background: #fff; border-radius: 16px; padding: 32px; margin-bottom: 24px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); }
        .card h1 { color: #2d7a32; margin-bottom: 20px; }
        .card label { display: block; font-weight: 600; margin-top: 12px; color: #333; }
        .card input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px; box-sizing: border-box; }
        .card .cta-primary { border-radius: 20px; padding: 12px 24px; margin-top: 20px; width: 100%; }
        .card .links { margin-top: 20px; text-align: center; }
        .card .links a { color: #2d7a32; margin: 0 10px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .top-bar .logo { font-size: 1.4rem; font-weight: 800; text-decoration: none; color: #333; }
        .top-bar .logo span { color: #2d7a32; }
        .top-bar a { color: #2d7a32; text-decoration: none; font-weight: 600; }
        #accountMessage { margin-top: 12px; padding: 12px; border-radius: 8px; display: none; min-height: 20px; }
    </style>
</head>
<body>
    <div class="lang-bar">
        <button type="button" id="btn-pt" class="lang-btn active">PT</button>
        <button type="button" id="btn-en" class="lang-btn">EN</button>
    </div>
    <div class="page-wrap">
        <div class="card">
            <h1 id="accountTitle" data-en="My account" data-pt="A minha conta">A minha conta</h1>
            <form id="accountForm">
                <label for="fullName" data-en="Full name" data-pt="Nome completo">Nome completo</label>
                <input type="text" id="fullName">
                <label for="email" data-en="Email" data-pt="Email">Email</label>
                <input type="email" id="email">
                <label for="phone" data-en="Phone" data-pt="Telemóvel">Telemóvel</label>
                <input type="tel" id="phone">
                <label for="address" data-en="Address" data-pt="Morada">Morada</label>
                <input type="text" id="address">
                <label for="postal" data-en="Postal code" data-pt="Código postal">Código postal</label>
                <input type="text" id="postal">
                <label for="city" data-en="City" data-pt="Cidade">Cidade</label>
                <input type="text" id="city">
                <label for="location" data-en="District / Location" data-pt="Freguesia / Localização">Freguesia / Localização</label>
                <input type="text" id="location">
                <label for="country" data-en="Country" data-pt="País">País</label>
                <select id="country">
                    <option value="Portugal">Portugal</option>
                    <option value="Spain">Spain / Espanha</option>
                    <option value="France">France / França</option>
                    <option value="United Kingdom">United Kingdom</option>
                    <option value="Germany">Germany / Alemanha</option>
                    <option value="Other">Other / Outro</option>
                </select>
                <button type="submit" id="saveBtn" class="cta-primary" data-en="Save details" data-pt="Guardar dados" style="border:none;cursor:pointer;width:100%;">Save details</button>
            </form>
            <div id="accountMessage"></div>
            <p id="accountNextStep" style="display:none; margin-top:12px; font-size:14px;">
                <a href="index.html" style="color:#2d7a32; font-weight:600;" data-en="← Back to shop" data-pt="← Voltar à loja">← Voltar à loja</a> &nbsp;|&nbsp; <a href="checkout.html" style="color:#2d7a32; font-weight:600;" data-en="Go to checkout" data-pt="Ir para o checkout">Ir para o checkout</a>
            </p>
            <div class="links">
                <a href="orders.html" id="linkOrders" data-en="My orders" data-pt="As minhas encomendas">As minhas encomendas</a>
                <a href="login.html" id="linkLogin" data-en="Log in with another account" data-pt="Entrar com outra conta">Entrar com outra conta</a>
            </div>
        </div>
    </div>
    <script>
        var accountT = { en: { saved: 'Details saved.' }, pt: { saved: 'Dados guardados.' } };
        function accountLang() { return localStorage.getItem('preferredLang') || 'pt'; }
        window.accountText = function(key) { var t = accountT[accountLang()]; return (t && t[key]) || accountT.pt[key] || key; };
        function setAccountLanguage(lang) {
            localStorage.setItem('preferredLang', lang);
            var nodes = document.querySelectorAll('[data-en][data-pt]');
            for (var i = 0; i < nodes.length; i++) {
                var el = nodes[i];
                var val = el.getAttribute('data-' + lang);
                if (val) {
                    if (el.tagName === 'A' && val.indexOf('&') !== -1) el.innerHTML = val;
                    else el.textContent = val;
                }
            }
            var bPt = document.getElementById('btn-pt');
            var bEn = document.getElementById('btn-en');
            if (bPt) bPt.classList.toggle('active', lang === 'pt');
            if (bEn) bEn.classList.toggle('active', lang === 'en');
            document.title = (lang === 'en' ? 'My account' : 'A minha conta') + ' | Braga Bazaar';
        }
        (function initLang() {
            setAccountLanguage(accountLang());
            document.getElementById('btn-pt').onclick = function() { setAccountLanguage('pt'); };
            document.getElementById('btn-en').onclick = function() { setAccountLanguage('en'); };
        })();
    </script>
    <script>
        document.getElementById('accountForm').addEventListener('submit', function(e) { e.preventDefault(); }, true);
    </script>
    <script type="module">
        import { supabase } from './supabaseConfig.js';

        const raw = localStorage.getItem('bragaBazaarUser');
        const user = raw ? JSON.parse(raw) : {};
        const form = document.getElementById('accountForm');
        const msg = document.getElementById('accountMessage');
        const saveBtn = document.getElementById('saveBtn');

        if (user.fullName) document.getElementById('fullName').value = user.fullName;
        if (user.email) document.getElementById('email').value = user.email;
        if (user.phone) document.getElementById('phone').value = user.phone;
        if (user.address) document.getElementById('address').value = user.address;
        if (user.postal) document.getElementById('postal').value = user.postal;
        if (user.city) document.getElementById('city').value = user.city;
        if (user.location) document.getElementById('location').value = user.location;
        if (user.country) document.getElementById('country').value = user.country || 'Portugal';

        function showMsg(text, isError) {
            if (!msg) return;
            msg.style.display = 'block';
            msg.style.background = isError ? '#fee' : '#e8f5e9';
            msg.style.color = isError ? '#c00' : '#2d7a32';
            msg.textContent = text;
        }

        form.onsubmit = async function (e) {
            e.preventDefault();
            if (!msg || !saveBtn) return;
            var savingText = (typeof window.accountLang === 'function' && window.accountLang() === 'en') ? 'Saving...' : 'A guardar...';
            var savedText = window.accountText ? window.accountText('saved') : 'Dados guardados.';
            saveBtn.disabled = true;
            showMsg(savingText, false);

            const u = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address: document.getElementById('address').value.trim(),
                postal: document.getElementById('postal').value.trim(),
                city: document.getElementById('city').value.trim(),
                location: document.getElementById('location').value.trim(),
                country: document.getElementById('country').value.trim()
            };

            try {
                var session = (await supabase.auth.getSession()).data?.session;
                if (session) {
                    var { error } = await supabase.auth.updateUser({
                        data: {
                            fullName: u.fullName,
                            phone: u.phone,
                            address: u.address,
                            postal: u.postal,
                            city: u.city,
                            location: u.location,
                            country: u.country
                        }
                    });
                    if (error) {
                        showMsg(((typeof window.accountLang === 'function' && window.accountLang() === 'en') ? 'Error saving: ' : 'Erro ao guardar: ') + error.message, true);
                        saveBtn.disabled = false;
                        return;
                    }
                }
                localStorage.setItem('bragaBazaarUser', JSON.stringify(u));
                showMsg(savedText, false);
                var next = document.getElementById('accountNextStep');
                if (next) next.style.display = 'block';
            } catch (err) {
                console.error(err);
                showMsg(((typeof window.accountLang === 'function' && window.accountLang() === 'en') ? 'Error: ' : 'Erro: ') + (err?.message || ''), true);
            }
            saveBtn.disabled = false;
        };
    </script>
</body>
</html>
