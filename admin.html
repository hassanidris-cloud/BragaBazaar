<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Suite | Braga Bazaar</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    :root{
      --green:#2d7a32;
      --green2:#1e5222;
      --slate:#1e293b;
      --muted:#64748b;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --shadow:0 4px 18px rgba(15,23,42,0.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--slate); font-family:'Inter',system-ui,-apple-system,sans-serif; }
    a{ color:inherit; }

    .admin-wrapper{ max-width:1200px; margin:18px auto; padding:0 16px; }

    /* Top bar */
    .top-bar{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin-bottom:14px;
    }
    .brand h1{ margin:0; font-weight:800; color:var(--green); letter-spacing:0.3px; }
    .brand p{ margin:6px 0 0; color:var(--muted); font-size:0.9rem; }

    .top-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:700; font-size:0.82rem;
      border:1px solid var(--border); background:#fff;
    }
    .chip .dot{ width:8px; height:8px; border-radius:50%; background:#94a3b8; }
    .chip.online .dot{ background:#22c55e; }
    .chip.offline .dot{ background:#ef4444; }
    .chip small{ color:var(--muted); font-weight:700; }

    /* Tabs */
    .tab-nav{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px; background:#fff; border:1px solid var(--border);
      border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,0.05);
      margin-bottom:18px;
    }
    .tab-btn{
      appearance:none; border:1px solid transparent; background:transparent;
      padding:10px 14px; border-radius:12px;
      font-weight:800; color:var(--muted); cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition:0.15s ease;
    }
    .tab-btn:hover{ background:#f1f5f9; color:var(--slate); }
    .tab-btn.active{
      background:#f1f5f9; color:var(--green);
      border-color:#dbeafe;
    }

    /* Cards */
    .content-section{ display:none; }
    .content-section.active{ display:block; }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px; margin-bottom:16px;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .card-header h2{ margin:0; font-size:1.15rem; }
    .subtle{ color:var(--muted); font-size:0.9rem; margin:6px 0 0; }

    /* Controls */
    .control-row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .input, .select{
      padding:11px 12px; border:1px solid var(--border);
      border-radius:12px; background:#fff; color:var(--slate);
      outline:none;
    }
    .input:focus, .select:focus{ border-color:#94a3b8; box-shadow:0 0 0 4px rgba(148,163,184,0.18); }
    .input{ min-width:220px; flex:1; }
    .select{ min-width:170px; font-weight:700; }

    /* Buttons */
    .btn{
      border:none; border-radius:12px; padding:10px 14px;
      font-weight:800; cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition:0.15s ease;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-dark{ background:var(--slate); color:#fff; }
    .btn-green{ background:var(--green); color:#fff; }
    .btn-green:hover{ background:var(--green2); }
    .btn-red{ background:#ef4444; color:#fff; }
    .btn-red:hover{ background:#dc2626; }
    .btn-gray{ background:#f1f5f9; color:#334155; border:1px solid var(--border); }
    .btn-icon{
      padding:9px 10px; border-radius:12px;
      background:#f1f5f9; border:1px solid var(--border); color:#334155;
    }
    .btn-icon:hover{ background:#e2e8f0; }

    /* Table */
    .table-wrap{ width:100%; overflow:auto; border-radius:14px; border:1px solid var(--border); }
    table{ width:100%; border-collapse:collapse; min-width:860px; background:#fff; }
    th{
      text-align:left; padding:12px 12px; background:#f8fafc;
      color:var(--muted); font-size:0.75rem;
      text-transform:uppercase; letter-spacing:0.07em;
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:1;
    }
    td{ padding:14px 12px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
    tr:hover td{ background:#fbfdff; }

    code.tag{
      background:#f1f5f9; padding:4px 8px; border-radius:999px;
      border:1px solid #e2e8f0; font-weight:800; font-size:0.82rem;
    }

    /* Badges */
    .badge{
      padding:6px 10px; border-radius:999px;
      font-size:0.72rem; font-weight:900; text-transform:uppercase;
      display:inline-flex; align-items:center; gap:8px;
    }
    .status-pending{ background:#fef3c7; color:#92400e; }
    .status-shipped{ background:#e0f2fe; color:#075985; }
    .status-delivered{ background:#dcfce7; color:#166534; }
    .badge-new{ background:var(--green); color:#fff; }

    /* Inventory inputs */
    .mini-input{
      width:92px; padding:9px 10px; text-align:center; font-weight:900;
      border-radius:12px; border:1px solid var(--border);
      outline:none;
    }
    .mini-input:focus{ border-color:#94a3b8; box-shadow:0 0 0 4px rgba(148,163,184,0.18); }
    .stock-low{ color:#ef4444; }

    /* Role-based UI helper */
    .hidden{ display:none !important; }

    /* Modal */
    .modal{
      display:none; position:fixed; inset:0; z-index:9999;
      background:rgba(2,6,23,0.55);
      align-items:center; justify-content:center; padding:18px;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width:100%; max-width:720px;
      background:#fff; border-radius:18px;
      border:1px solid var(--border); box-shadow:0 18px 60px rgba(0,0,0,0.28);
      max-height:90vh; overflow:auto;
    }
    .modal-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:16px 16px 10px; border-bottom:1px solid var(--border);
    }
    .modal-head h3{ margin:0; font-size:1.1rem; }
    .modal-body{ padding:16px; }
    .kvs{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .kv{
      border:1px solid var(--border); border-radius:14px;
      padding:12px; background:#fbfdff;
    }
    .kv small{ display:block; color:var(--muted); font-weight:800; margin-bottom:4px; }
    .kv div{ font-weight:800; }
    .items{
      margin-top:14px; border:1px solid var(--border); border-radius:14px; overflow:hidden;
    }
    .items header{
      padding:10px 12px; background:#f8fafc; color:var(--muted);
      font-weight:900; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.06em;
      border-bottom:1px solid var(--border);
    }
    .items .row{
      display:flex; justify-content:space-between; gap:12px;
      padding:12px; border-bottom:1px solid #f1f5f9;
      font-weight:800;
    }
    .items .row:last-child{ border-bottom:none; }
    .items .row span{ color:var(--muted); font-weight:900; }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .muted-note{ color:var(--muted); font-size:0.88rem; margin-top:10px; }

    /* PIN gate */
    #adminPinScreen{ display:none; min-height:100vh; align-items:center; justify-content:center; padding:20px; }
    .pin-card{
      background:#fff; border-radius:18px; border:1px solid var(--border);
      box-shadow:var(--shadow); width:100%; max-width:380px;
      padding:28px;
    }
    .pin-card h1{ margin:0 0 6px 0; font-weight:900; color:var(--green); }
    .pin-card p{ margin:0 0 18px 0; color:var(--muted); font-size:0.92rem; }
    .pin-card label{ display:block; font-weight:900; margin-bottom:8px; color:#334155; }
    .pin-card input{
      width:100%; padding:14px 16px; border-radius:14px;
      border:1px solid var(--border); font-size:1.2rem;
      letter-spacing:0.28em; text-align:center; outline:none;
    }
    .pin-card input:focus{ border-color:#94a3b8; box-shadow:0 0 0 4px rgba(148,163,184,0.18); }
    .pin-error{ display:none; color:#dc2626; font-weight:800; font-size:0.86rem; margin-top:10px; }

    /* Responsive */
    @media (max-width: 860px){
      .kvs{ grid-template-columns:1fr; }
      .input{ min-width:160px; }
      .select{ min-width:160px; }
      .top-bar{ align-items:flex-start; }
    }
  </style>
</head>

<body>

  <!-- PIN gate -->
  <div id="adminPinScreen">
    <div class="pin-card">
      <h1>BRAGA BAZAAR</h1>
      <p>Admin access</p>

      <form id="adminPinForm">
        <label for="adminPinInput">Enter PIN</label>
        <input type="password" id="adminPinInput" inputmode="numeric" pattern="[0-9]*"
               autocomplete="off" placeholder="••••" maxlength="8" required />
        <div id="adminPinError" class="pin-error"></div>

        <button type="submit" class="btn btn-green" style="width:100%; margin-top:14px; justify-content:center;">
          <i class="fas fa-lock-open"></i> Continue
        </button>
      </form>

      <p style="margin:18px 0 0; text-align:center;">
        <a href="login.html?redirect=admin.html" style="color:var(--green); font-weight:900; text-decoration:none;">
          Or log in with email
        </a>
      </p>

      <p class="muted-note" style="text-align:center;">
        Tip: for real security, enable Supabase RLS (PIN is only UI).
      </p>
    </div>
  </div>

  <!-- Main panel -->
  <div class="admin-wrapper" id="adminPanelContent" style="display:none;">
    <div class="top-bar">
      <div class="brand">
        <h1>BRAGA BAZAAR</h1>
        <p>Admin Management Suite</p>
      </div>

      <div class="top-actions">
        <div id="netChip" class="chip">
          <span class="dot"></span>
          <small id="netText">Checking…</small>
        </div>
        <div class="chip">
          <i class="fas fa-user-shield"></i>
          <small id="roleText">Role: …</small>
        </div>
        <button id="logoutBtn" class="btn btn-red"><i class="fas fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>

    <nav class="tab-nav" aria-label="Admin tabs">
      <button class="tab-btn active" data-tab="orders" type="button"><i class="fas fa-shopping-cart"></i> Orders</button>
      <button class="tab-btn" data-tab="inventory" type="button"><i class="fas fa-boxes"></i> Inventory</button>
      <button class="tab-btn" data-tab="reports" type="button"><i class="fas fa-chart-line"></i> Reports</button>
    </nav>

    <!-- ORDERS -->
    <section id="ordersSection" class="content-section active">
      <div class="card">
        <div class="card-header">
          <div>
            <h2><i class="fas fa-receipt"></i> Orders</h2>
            <p class="subtle">All orders from all customers. Search, filter, view details, and update status.</p>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" class="btn btn-gray" id="refreshOrdersBtn" title="Reload orders">
              <i class="fas fa-rotate"></i> Refresh
            </button>
            <button type="button" class="btn btn-dark" id="exportOrdersBtn" title="Download orders CSV">
              <i class="fas fa-file-csv"></i> Export CSV
            </button>
          </div>
        </div>

        <div class="control-row">
          <input class="input" type="text" id="orderSearch" placeholder="Search by name, phone, email, or ID…" />
          <select class="select" id="orderStatusFilter">
            <option value="">All statuses</option>
            <option value="pending">Pending</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
          </select>
          <input class="select" type="date" id="orderDateFrom" title="From date" />
          <input class="select" type="date" id="orderDateTo" title="To date" />
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Order</th>
                <th>Customer</th>
                <th>Shipping</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th style="min-width:220px;">Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventorySection" class="content-section">
      <!-- Add product (admin only) -->
      <div class="card" id="addProductCard">
        <div class="card-header">
          <div>
            <h2><i class="fas fa-circle-plus"></i> Add new product</h2>
            <p class="subtle">Admins can add products. Staff can update stock & price.</p>
          </div>
        </div>

        <form id="addProductForm" class="pure-form pure-form-stacked"
              style="display:grid; grid-template-columns:1fr 1fr; gap:14px; max-width:900px;">
          <label style="font-weight:800;">Name
            <input class="input" style="width:100%;" type="text" id="newName" required placeholder="e.g. Organic Apples" />
          </label>

          <label style="font-weight:800;">Category
            <select class="select" style="width:100%;" id="newCategory" required>
              <option value="fruits">Fruits & Vegetables</option>
              <option value="bakery">Bakery & Pastry</option>
              <option value="meat">Butcher / Meat</option>
              <option value="eggs">Eggs & Dairy</option>
              <option value="drinks">Drinks</option>
              <option value="coffee_tea_chocolate">Coffee, tea & chocolate</option>
              <option value="promotions">Promotions</option>
              <option value="cans_jars">Cans and jars</option>
              <option value="pasta_rice_cereals">Pasta, rice & cereals</option>
              <option value="sauces_condiments">Sauces and condiments</option>
              <option value="herbs_spices">Herbs and spices</option>
              <option value="frozen_foods">Frozen foods</option>
              <option value="snacks">Snacks</option>
              <option value="household_cleaning">Household and cleaning</option>
              <option value="personal_care">Personal care</option>
            </select>
          </label>

          <div id="newSubcategoryWrap" style="display:none;">
            <label style="font-weight:800;">Subcategory
              <select class="select" style="width:100%;" id="newSubcategory">
                <option value="">—</option>
              </select>
            </label>
          </div>

          <label style="font-weight:800;">Price (€)
            <input class="input" style="width:100%;" type="number" id="newPrice" required min="0" step="0.01" placeholder="2.99" />
          </label>

          <label style="font-weight:800;">Stock level
            <input class="input" style="width:100%;" type="number" id="newStock" min="0" value="0" />
          </label>

          <div id="unitPricePerKgWrap" style="display:none; grid-column:1/-1; grid-template-columns:1fr 1fr; gap:14px;">
            <label style="font-weight:800;">Unit
              <select class="select" style="width:100%;" id="newUnit">
                <option value="unit">Per item</option>
                <option value="kg">Per kg</option>
              </select>
            </label>
            <label style="font-weight:800;">Price per kg (€)
              <input class="input" style="width:100%;" type="number" id="newPricePerKg" min="0" step="0.01" placeholder="0" />
            </label>
          </div>

          <label style="font-weight:800;">SKU
            <input class="input" style="width:100%;" type="text" id="newSku" placeholder="e.g. FRUIT-001" />
          </label>

          <label style="font-weight:800;">Low stock alert
            <input class="input" style="width:100%;" type="number" id="newLowStock" min="0" placeholder="5" title="Alert when stock falls below this" />
          </label>

          <label style="grid-column:1/-1; font-weight:800;">Variants (optional)
            <input class="input" style="width:100%;" type="text" id="newVariants" placeholder='e.g. Size: S, M, L or Flavor: Natural, Honey' />
          </label>

          <label style="grid-column:1/-1; font-weight:800;">Image URL
            <input class="input" style="width:100%;" type="url" id="newImageUrl" placeholder="https://..." />
          </label>

          <label style="grid-column:1/-1; font-weight:800;">Description
            <input class="input" style="width:100%;" type="text" id="newDescription" placeholder="Short description" />
          </label>

          <div style="grid-column:1/-1; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button type="submit" class="btn btn-green"><i class="fas fa-plus"></i> Add product</button>
            <button type="button" class="btn btn-gray" id="addProductResetBtn"><i class="fas fa-eraser"></i> Reset</button>
            <span id="addProductMsg" style="color:var(--muted); font-weight:800;"></span>
          </div>
        </form>
      </div>

      <!-- Bulk import (admin only) -->
      <div class="card" id="bulkImportCard">
        <div class="card-header">
          <div>
            <h2><i class="fas fa-file-arrow-up"></i> Bulk upload (CSV)</h2>
            <p class="subtle">Columns: name, category, subcategory (drinks: waters, juices_softdrinks; coffee_tea_chocolate: coffee_capsules, ground_coffee_grain, soluble_decaf, tea_infusions, cereal_drinks, chocolate_milk), price, stock_level, image_url, description, unit, price_per_kg, sku, variants, low_stock_threshold</p>
          </div>
        </div>
        <div class="control-row">
          <input type="file" id="bulkCsvFile" accept=".csv" />
          <button type="button" class="btn btn-dark" id="bulkCsvBtn"><i class="fas fa-upload"></i> Import CSV</button>
          <button type="button" class="btn btn-gray" id="sampleCsvBtn"><i class="fas fa-download"></i> Sample CSV</button>
          <span id="bulkCsvMsg" style="color:var(--muted); font-weight:800;"></span>
        </div>
      </div>

      <!-- Inventory table -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2><i class="fas fa-boxes"></i> Inventory</h2>
            <p class="subtle">Search, filter low stock, update price/stock fast.</p>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" class="btn btn-dark" id="exportProductsBtn"><i class="fas fa-file-csv"></i> Export products CSV</button>
            <button type="button" class="btn btn-gray" id="refreshProductsBtn"><i class="fas fa-rotate"></i> Refresh</button>
          </div>
        </div>

        <div class="control-row">
          <input class="input" type="text" id="productSearch" placeholder="Search inventory by name or SKU…" />
          <select class="select" id="productCategoryFilter">
            <option value="">All categories</option>
            <option value="fruits">Fruits & Vegetables</option>
            <option value="bakery">Bakery & Pastry</option>
            <option value="meat">Butcher / Meat</option>
            <option value="eggs">Eggs & Dairy</option>
            <option value="drinks">Drinks</option>
            <option value="promotions">Promotions</option>
            <option value="cans_jars">Cans and jars</option>
            <option value="pasta_rice_cereals">Pasta, rice & cereals</option>
            <option value="sauces_condiments">Sauces and condiments</option>
            <option value="herbs_spices">Herbs and spices</option>
            <option value="frozen_foods">Frozen foods</option>
            <option value="snacks">Snacks</option>
            <option value="household_cleaning">Household and cleaning</option>
            <option value="personal_care">Personal care</option>
          </select>

          <label class="chip" style="cursor:pointer;">
            <input type="checkbox" id="lowStockOnly" style="margin:0;" />
            <small>Low stock only</small>
          </label>

          <button type="button" class="btn btn-gray" id="bulkSaveVisibleBtn" title="Save all visible rows">
            <i class="fas fa-floppy-disk"></i> Save visible
          </button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:240px;">Item</th>
                <th>SKU</th>
                <th>Price (€)</th>
                <th>Stock</th>
                <th style="min-width:220px;">Actions</th>
              </tr>
            </thead>
            <tbody id="inventoryTbody"></tbody>
          </table>
        </div>

        <p class="muted-note">
          Tip: “Remove” is a soft-disable (is_active=false) if your DB has that column. If it doesn’t, it will fall back to delete.
        </p>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reportsSection" class="content-section">
      <div class="card" style="text-align:center; padding:28px;">
        <div style="display:flex; justify-content:center; gap:40px; flex-wrap:wrap; margin-bottom:18px;">
          <div>
            <small style="color:var(--muted); font-weight:900; text-transform:uppercase;">Total Revenue</small>
            <h2 id="totalRevenue" style="font-size:2.3rem; margin:10px 0; color:var(--green);">€0.00</h2>
          </div>
          <div>
            <small style="color:var(--muted); font-weight:900; text-transform:uppercase;">Total Orders</small>
            <h2 id="totalOrdersCount" style="font-size:2.3rem; margin:10px 0; color:var(--slate);">0</h2>
          </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:18px auto; max-width:720px;" />

        <i class="fas fa-file-csv" style="font-size:3rem; color:var(--green); margin-bottom:10px;"></i>
        <h2 style="margin:8px 0 4px;">Financial Export</h2>
        <p style="color:var(--muted); margin:0 0 18px;">Download your sales history for bookkeeping.</p>

        <button id="exportReportBtn" class="btn btn-dark"><i class="fas fa-download"></i> Download CSV Report</button>
      </div>
    </section>
  </div>

  <!-- Order Details Modal -->
  <div class="modal" id="orderModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Order details">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="orderModalTitle">Order</h3>
        <button type="button" class="btn btn-icon" id="orderModalClose" aria-label="Close">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body" id="orderModalBody"></div>
    </div>
  </div>

  <!-- Edit Product Modal (full edit) -->
  <div class="modal" id="editProductModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Edit product">
    <div class="modal-card" style="max-width:760px;">
      <div class="modal-head">
        <h3 style="margin:0;">Edit product</h3>
        <button type="button" class="btn btn-icon" id="editModalClose" aria-label="Close">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="editProductForm">
          <input type="hidden" id="editProductId" />
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <label style="font-weight:900;">Name
              <input class="input" style="width:100%;" type="text" id="editName" required />
            </label>

            <label style="font-weight:900;">Category
              <select class="select" style="width:100%;" id="editCategory">
                <option value="fruits">Fruits & Vegetables</option>
                <option value="bakery">Bakery & Pastry</option>
                <option value="meat">Butcher / Meat</option>
                <option value="eggs">Eggs & Dairy</option>
                <option value="drinks">Drinks</option>
                <option value="coffee_tea_chocolate">Coffee, tea & chocolate</option>
                <option value="promotions">Promotions</option>
                <option value="cans_jars">Cans and jars</option>
                <option value="pasta_rice_cereals">Pasta, rice & cereals</option>
                <option value="sauces_condiments">Sauces and condiments</option>
                <option value="herbs_spices">Herbs and spices</option>
                <option value="frozen_foods">Frozen foods</option>
                <option value="snacks">Snacks</option>
                <option value="household_cleaning">Household and cleaning</option>
                <option value="personal_care">Personal care</option>
              </select>
            </label>

            <div id="editSubcategoryWrap" style="display:none;">
              <label style="font-weight:900;">Subcategory
                <select class="select" style="width:100%;" id="editSubcategory">
                  <option value="">—</option>
                </select>
              </label>
            </div>

            <label style="font-weight:900;">Price (€)
              <input class="input" style="width:100%;" type="number" id="editPrice" min="0" step="0.01" required />
            </label>

            <label style="font-weight:900;">Stock
              <input class="input" style="width:100%;" type="number" id="editStock" min="0" />
            </label>

            <div id="editUnitWrap" style="display:none; grid-column:1/-1; grid-template-columns:1fr 1fr; gap:12px;">
              <label style="font-weight:900;">Unit
                <select class="select" style="width:100%;" id="editUnit">
                  <option value="unit">Per item</option>
                  <option value="kg">Per kg</option>
                </select>
              </label>
              <label style="font-weight:900;">Price per kg (€)
                <input class="input" style="width:100%;" type="number" id="editPricePerKg" min="0" step="0.01" />
              </label>
            </div>

            <label style="grid-column:1/-1; font-weight:900;">Image URL
              <input class="input" style="width:100%;" type="url" id="editImageUrl" />
            </label>

            <label style="grid-column:1/-1; font-weight:900;">Description
              <input class="input" style="width:100%;" type="text" id="editDescription" />
            </label>

            <label style="font-weight:900;">SKU
              <input class="input" style="width:100%;" type="text" id="editSku" />
            </label>

            <label style="font-weight:900;">Low stock alert
              <input class="input" style="width:100%;" type="number" id="editLowStock" min="0" />
            </label>

            <label style="grid-column:1/-1; font-weight:900;">Variants
              <input class="input" style="width:100%;" type="text" id="editVariants" placeholder="e.g. Size: S, M, L" />
            </label>

            <label style="grid-column:1/-1; font-weight:900;">Active (if supported)
              <select class="select" style="width:100%;" id="editIsActive">
                <option value="auto">Keep as-is</option>
                <option value="true">Active</option>
                <option value="false">Disabled</option>
              </select>
            </label>
          </div>

          <div class="modal-actions">
            <button type="submit" class="btn btn-green"><i class="fas fa-floppy-disk"></i> Save changes</button>
            <button type="button" class="btn btn-gray" id="editCancelBtn"><i class="fas fa-ban"></i> Cancel</button>
          </div>
        </form>

        <p class="muted-note">
          Note: if your DB doesn’t have some fields (like is_active, price_per_kg), this form still works — those fields will just be ignored.
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase, ADMIN_EMAILS, ADMIN_PIN } from './supabaseConfig.js';

    // =========================
    // Small helpers
    // =========================
    const PIN_STORAGE_KEY = 'adminPinOk';
    const CACHE_ORDERS_KEY = 'bb_admin_cache_orders_v1';
    const CACHE_PRODUCTS_KEY = 'bb_admin_cache_products_v1';
    const NEW_ORDER_HOURS = 48;
    const PER_KG_CATEGORIES = ['fruits', 'meat'];
    const ADMIN_SUB_OPTS = {
      drinks: [{ v: 'waters', l: 'Waters' }, { v: 'juices_softdrinks', l: 'Juices & Soft Drinks' }],
      coffee_tea_chocolate: [
        { v: 'coffee_capsules', l: 'Coffee Capsules' },
        { v: 'ground_coffee_grain', l: 'Ground Coffee and Grain' },
        { v: 'soluble_decaf', l: 'Soluble and Decaffeinated Coffee' },
        { v: 'tea_infusions', l: 'Tea and Infusions' },
        { v: 'cereal_drinks', l: 'Cereal Drinks' },
        { v: 'chocolate_milk', l: 'Chocolate milk' }
      ]
    };
    function fillSubcategorySelect(selectEl, category) {
      if (!selectEl) return;
      const cat = (category || '').toLowerCase();
      const opts = ADMIN_SUB_OPTS[cat];
      const current = selectEl.value;
      selectEl.innerHTML = '<option value="">—</option>';
      if (opts && opts.length) {
        opts.forEach(function(o) {
          const opt = document.createElement('option');
          opt.value = o.v;
          opt.textContent = o.l;
          selectEl.appendChild(opt);
        });
        if (current && opts.some(function(o) { return o.v === current; })) selectEl.value = current;
        else selectEl.value = '';
      }
    }

    let currentUser = null;
    let currentRole = 'employee'; // 'admin' | 'employee'
    let allOrders = [];
    let allProducts = [];

    const $ = (id) => document.getElementById(id);

    function nowIso() { return new Date().toISOString(); }

    function safeLower(x){ return (x || '').toString().toLowerCase(); }

    function setOnlineChip(isOnline){
      const chip = $('netChip');
      const text = $('netText');
      if (!chip || !text) return;
      chip.classList.toggle('online', !!isOnline);
      chip.classList.toggle('offline', !isOnline);
      text.textContent = isOnline ? 'Online' : 'Offline';
    }

    function formatMoney(v){
      const n = Number(v || 0);
      return '€' + n.toFixed(2);
    }

    function isNewOrder(createdAt){
      if (!createdAt) return false;
      const then = new Date(createdAt).getTime();
      return (Date.now() - then) < NEW_ORDER_HOURS * 60 * 60 * 1000;
    }

    function cacheWrite(key, payload){
      try { localStorage.setItem(key, JSON.stringify({ at: Date.now(), payload })); } catch {}
    }

    function cacheRead(key){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed?.payload ?? null;
      }catch{ return null; }
    }

    function showToast(msg){
      // minimal toast for admin actions
      let t = document.getElementById('bbToast');
      if (!t){
        t = document.createElement('div');
        t.id = 'bbToast';
        t.style.cssText =
          'position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(80px);' +
          'background:#1e293b; color:#fff; padding:12px 16px; border-radius:14px; font-weight:800; z-index:10000;' +
          'box-shadow:0 12px 30px rgba(0,0,0,0.35); opacity:0; transition:0.25s ease; max-width:92vw;';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = '1';
      t.style.transform = 'translateX(-50%) translateY(0)';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        t.style.opacity = '0';
        t.style.transform = 'translateX(-50%) translateY(80px)';
      }, 1800);
    }

    // =========================
    // Require admin (redirect if not logged in / not admin)
    // =========================
    async function requireAdmin(){
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        window.location.href = 'admin-login.html';
        return false;
      }

      const email = safeLower(user.email || '');
      const isAdmin = Array.isArray(ADMIN_EMAILS) && ADMIN_EMAILS.length && ADMIN_EMAILS.some(e => safeLower(e) === email);
      if (!isAdmin) {
        await supabase.auth.signOut();
        window.location.href = 'admin-login.html';
        return false;
      }

      const { error } = await supabase.from('orders').select('id').limit(1);
      if (error) {
        await supabase.auth.signOut();
        window.location.href = 'admin-login.html';
        return false;
      }

      return true;
    }

    // =========================
    // Auth + PIN gate
    // =========================
    async function determineRoleFromEmail(session){
      const email = safeLower(session?.user?.email || '');
      const allowedAdmins =
        Array.isArray(ADMIN_EMAILS) &&
        ADMIN_EMAILS.length &&
        ADMIN_EMAILS.some(e => safeLower(e) === email);

      // If you later add profiles.role, you can override here:
      // const { data } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
      // if (data?.role) return data.role;

      return allowedAdmins ? 'admin' : 'employee';
    }

    async function adminGate(){
      const pinScreen = $('adminPinScreen');
      const panel = $('adminPanelContent');

      const ok = await requireAdmin();
      if (!ok) return;

      const { data: { session } } = await supabase.auth.getSession();
      if (session){
        currentUser = session.user;
        currentRole = await determineRoleFromEmail(session);
        pinScreen.style.display = 'none';
        panel.style.display = 'block';
        applyRoleUI();
        boot();
        return;
      }

      window.location.href = 'admin-login.html';
    }

    function applyRoleUI(){
      $('roleText').textContent = 'Role: ' + (currentRole || 'employee');

      // Admin-only sections
      const adminOnlyEls = [ $('addProductCard'), $('bulkImportCard') ];
      adminOnlyEls.forEach(el => {
        if (!el) return;
        el.classList.toggle('hidden', currentRole !== 'admin');
      });

      // Export products is okay for both; delete actions will be hidden for employees in render
    }

    // =========================
    // Tabs
    // =========================
    function bindTabs(){
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
          if (tab === 'orders') $('ordersSection').classList.add('active');
          if (tab === 'inventory') $('inventorySection').classList.add('active');
          if (tab === 'reports') $('reportsSection').classList.add('active');
        });
      });
    }

    // =========================
    // Network indicator
    // =========================
    function bindOnlineState(){
      function update(){ setOnlineChip(navigator.onLine); }
      window.addEventListener('online', update);
      window.addEventListener('offline', update);
      update();
    }

    // =========================
    // Load data + cache
    // =========================
    async function loadOrders({ silent=false } = {}){
      // show cached instantly
      const cached = cacheRead(CACHE_ORDERS_KEY);
      if (cached && !allOrders.length){
        allOrders = cached;
        renderOrders(getFilteredOrders());
        updateReportStats();
      }

      const res = await supabase.from('orders').select('*').order('created_at', { ascending: false });
      if (res.error){
        if (!silent) showToast('Could not load orders (offline?). Showing cached if available.');
        console.error(res.error);
        return;
      }
      allOrders = res.data || [];
      cacheWrite(CACHE_ORDERS_KEY, allOrders);
      renderOrders(getFilteredOrders());
      updateReportStats();
    }

    async function loadProducts({ silent=false } = {}){
      const cached = cacheRead(CACHE_PRODUCTS_KEY);
      if (cached && !allProducts.length){
        allProducts = cached;
        renderInventory(getFilteredProducts());
      }

      // If your products table has is_active, we still fetch all so admin can see disabled items
      const res = await supabase.from('products').select('*').order('name', { ascending: true });
      if (res.error){
        if (!silent) showToast('Could not load products (offline?). Showing cached if available.');
        console.error(res.error);
        return;
      }
      allProducts = res.data || [];
      cacheWrite(CACHE_PRODUCTS_KEY, allProducts);
      renderInventory(getFilteredProducts());
    }

    async function loadAll(){
      await Promise.all([ loadOrders({ silent:true }), loadProducts({ silent:true }) ]);
      // initial render is inside loaders
    }

    // =========================
    // Reports
    // =========================
    function updateReportStats(){
      const total = allOrders.reduce((sum, o) => sum + Number(o.total ?? o.total_price ?? 0), 0);
      $('totalRevenue').textContent = formatMoney(total);
      $('totalOrdersCount').textContent = String(allOrders.length || 0);
    }

    // =========================
    // Orders: filter + render
    // =========================
    function getFilteredOrders(){
      const term = safeLower($('orderSearch')?.value || '').trim();
      const status = safeLower($('orderStatusFilter')?.value || '').trim();
      const from = $('orderDateFrom')?.value || '';
      const to = $('orderDateTo')?.value || '';

      return allOrders.filter(o => {
        const idStr = safeLower(o.id ?? '');
        const name = safeLower(o.full_name ?? '');
        const phone = (o.phone ?? '').toString();
        const email = safeLower(o.email ?? '');

        if (term){
          const match = name.includes(term) || phone.includes(term) || email.includes(term) || idStr.includes(term);
          if (!match) return false;
        }

        const s = safeLower(o.status ?? 'pending');
        if (status && s !== status) return false;

        const created = o.created_at ? new Date(o.created_at) : null;
        if (from && created && created < new Date(from + 'T00:00:00')) return false;
        if (to && created && created > new Date(to + 'T23:59:59')) return false;

        return true;
      });
    }

    function statusBadge(status){
      const s = safeLower(status || 'pending');
      const cls = s === 'delivered' ? 'status-delivered' : s === 'shipped' ? 'status-shipped' : 'status-pending';
      return `<span class="badge ${cls}">${s}</span>`;
    }

    function safeHtml(str){
      return (str ?? '').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function renderOrders(orders){
      const tbody = $('ordersTbody');
      if (!tbody) return;

      if (!orders || orders.length === 0){
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:24px; color:var(--muted); font-weight:800;">
          No orders found.
        </td></tr>`;
        return;
      }

      tbody.innerHTML = orders.map(o => {
        const idStrFull = (o.id != null ? String(o.id) : '');
        const idShort = idStrFull.slice(0, 8);
        const totalVal = o.total ?? o.total_price ?? 0;
        const shipping = [o.address, o.city, o.postal].filter(Boolean).join(', ') || '—';
        const payment = o.payment_method || o.payment || '—';
        const newBadge = isNewOrder(o.created_at) ? `<span class="badge badge-new">New</span>` : '';

        const status = safeLower(o.status || 'pending');
        const canShip = status !== 'shipped' && status !== 'delivered';
        const canDeliver = status !== 'delivered';

        return `
          <tr>
            <td>
              <code class="tag">#${safeHtml(idShort)}</code>
              ${newBadge}
              <div style="margin-top:6px;">
                <button class="btn btn-icon" data-action="view-order" data-id="${safeHtml(idStrFull)}" title="View details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-icon" data-action="print-order" data-id="${safeHtml(idStrFull)}" title="Print invoice">
                  <i class="fas fa-print"></i>
                </button>
              </div>
            </td>

            <td>
              <div style="font-weight:900;">${safeHtml((o.full_name || '').trim() || '—')}</div>
              <div style="color:var(--muted); font-weight:800; margin-top:4px;">
                <i class="fab fa-whatsapp"></i> ${safeHtml(o.phone || '—')}
              </div>
              <div style="color:var(--muted); font-weight:800;">
                ${safeHtml(o.email || '')}
              </div>
            </td>

            <td style="max-width:220px;">
              <div style="color:var(--muted); font-weight:800;">${safeHtml(shipping)}</div>
            </td>

            <td style="font-weight:900;">${formatMoney(totalVal)}</td>

            <td><div style="color:var(--muted); font-weight:900;">${safeHtml(payment)}</div></td>

            <td>${statusBadge(o.status)}</td>

            <td>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                ${canShip ? `
                  <button type="button" class="btn btn-green" data-action="status" data-id="${safeHtml(idStrFull)}" data-status="shipped" title="Mark shipped">
                    <i class="fas fa-truck"></i> Shipped
                  </button>` : ''}

                ${canDeliver ? `
                  <button type="button" class="btn btn-dark" data-action="status" data-id="${safeHtml(idStrFull)}" data-status="delivered" title="Mark delivered">
                    <i class="fas fa-circle-check"></i> Delivered
                  </button>` : ''}

                <button type="button" class="btn btn-gray" data-action="copy-id" data-id="${safeHtml(idStrFull)}" title="Copy order ID">
                  <i class="fas fa-copy"></i> Copy ID
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function bindOrderFilters(){
      ['orderSearch','orderStatusFilter','orderDateFrom','orderDateTo'].forEach(id => {
        const el = $(id);
        if (!el) return;
        el.addEventListener(id === 'orderSearch' ? 'input' : 'change', () => renderOrders(getFilteredOrders()));
      });
    }

    // =========================
    // Order actions
    // =========================
    async function setOrderStatus(orderId, status){
      const { error } = await supabase.from('orders').update({ status }).eq('id', orderId);
      if (error){
        alert('Update failed: ' + (error.message || error));
        return;
      }
      const o = allOrders.find(x => String(x.id) === String(orderId));
      if (o) o.status = status;
      showToast('Order updated to ' + status);
      renderOrders(getFilteredOrders());
      updateReportStats();
    }

    function tryParseItems(order){
      // supports common shapes: items array, cart_items, order_items, items_json
      const candidates = [order.items, order.order_items, order.cart_items, order.items_json];
      for (const c of candidates){
        if (!c) continue;
        if (Array.isArray(c)) return c;
        if (typeof c === 'string'){
          try{
            const j = JSON.parse(c);
            if (Array.isArray(j)) return j;
          }catch{}
        }
        if (typeof c === 'object'){
          // sometimes stored as object with array inside
          if (Array.isArray(c.items)) return c.items;
        }
      }
      return [];
    }

    function openOrderModal(orderId){
      const o = allOrders.find(x => String(x.id) === String(orderId));
      if (!o) return;

      const idShort = String(o.id || '').slice(0, 8);
      $('orderModalTitle').textContent = 'Order #' + idShort;

      const shipping = [o.address, o.city, o.postal].filter(Boolean).join(', ') || '—';
      const payment = o.payment_method || o.payment || '—';
      const totalVal = o.total ?? o.total_price ?? 0;
      const created = o.created_at ? new Date(o.created_at) : null;

      const items = tryParseItems(o);
      const itemsHtml = items.length ? items.map(it => {
        const name = it.name || it.product_name || it.title || 'Item';
        const qty = Number(it.qty ?? it.quantity ?? 1);
        const price = Number(it.price ?? it.unit_price ?? 0);
        const line = price * qty;
        return `<div class="row">
          <div>${safeHtml(name)} <span>× ${qty}</span></div>
          <div>${formatMoney(line || price)}</div>
        </div>`;
      }).join('') : `<div class="row"><div style="color:var(--muted); font-weight:900;">No line items stored on this order.</div><div></div></div>`;

      const body = `
        <div class="kvs">
          <div class="kv"><small>Customer</small><div>${safeHtml(o.full_name || '—')}</div></div>
          <div class="kv"><small>Phone</small><div>${safeHtml(o.phone || '—')}</div></div>
          <div class="kv"><small>Email</small><div>${safeHtml(o.email || '—')}</div></div>
          <div class="kv"><small>Status</small><div>${safeHtml(o.status || 'pending')}</div></div>
          <div class="kv"><small>Payment</small><div>${safeHtml(payment)}</div></div>
          <div class="kv"><small>Created</small><div>${created ? created.toLocaleString() : '—'}</div></div>
          <div class="kv" style="grid-column:1/-1;"><small>Shipping</small><div>${safeHtml(shipping)}</div></div>
          <div class="kv" style="grid-column:1/-1;"><small>Total</small><div>${formatMoney(totalVal)}</div></div>
        </div>

        <div class="items">
          <header>Items</header>
          ${itemsHtml}
        </div>

        <div class="modal-actions">
          ${safeLower(o.status) !== 'shipped' && safeLower(o.status) !== 'delivered' ? `
            <button type="button" class="btn btn-green" data-action="modal-status" data-id="${safeHtml(o.id)}" data-status="shipped">
              <i class="fas fa-truck"></i> Mark shipped
            </button>` : ''}

          ${safeLower(o.status) !== 'delivered' ? `
            <button type="button" class="btn btn-dark" data-action="modal-status" data-id="${safeHtml(o.id)}" data-status="delivered">
              <i class="fas fa-circle-check"></i> Mark delivered
            </button>` : ''}

          <button type="button" class="btn btn-gray" data-action="modal-print" data-id="${safeHtml(o.id)}">
            <i class="fas fa-print"></i> Print
          </button>

          <button type="button" class="btn btn-gray" data-action="modal-copy" data-id="${safeHtml(o.id)}">
            <i class="fas fa-copy"></i> Copy ID
          </button>
        </div>

        <p class="muted-note">
          If you want line-items here, store an <code>items</code> array on each order (name, qty, price).
        </p>
      `;

      $('orderModalBody').innerHTML = body;

      const modal = $('orderModal');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeOrderModal(){
      const modal = $('orderModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    function printInvoice(orderId){
      const o = allOrders.find(x => String(x.id) === String(orderId));
      if (!o) return;

      const idShort = String(o.id || '').slice(0, 8);
      const totalVal = o.total ?? o.total_price ?? 0;
      const shipping = [o.address, o.city, o.postal].filter(Boolean).join(', ') || '—';
      const items = tryParseItems(o);

      const itemsHtml = items.length ? `
        <h3 style="margin:18px 0 8px;">Items</h3>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:8px;">Item</th>
              <th style="text-align:right; border-bottom:1px solid #e2e8f0; padding:8px;">Qty</th>
              <th style="text-align:right; border-bottom:1px solid #e2e8f0; padding:8px;">Price</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(it => {
              const name = it.name || it.product_name || it.title || 'Item';
              const qty = Number(it.qty ?? it.quantity ?? 1);
              const price = Number(it.price ?? it.unit_price ?? 0);
              return `
                <tr>
                  <td style="padding:8px; border-bottom:1px solid #f1f5f9;">${safeHtml(name)}</td>
                  <td style="padding:8px; text-align:right; border-bottom:1px solid #f1f5f9;">${qty}</td>
                  <td style="padding:8px; text-align:right; border-bottom:1px solid #f1f5f9;">${formatMoney(price)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      ` : '';

      const win = window.open('', '_blank');
      win.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Order #${safeHtml(idShort)}</title>
            <meta charset="utf-8"/>
          </head>
          <body style="font-family:Inter,system-ui,-apple-system,sans-serif; padding:24px; color:#0f172a;">
            <h1 style="margin:0 0 10px; color:#2d7a32;">Braga Bazaar</h1>
            <h2 style="margin:0 0 14px;">Order #${safeHtml(idShort)}</h2>
            <p><strong>Customer:</strong> ${safeHtml(o.full_name || '—')}</p>
            <p><strong>Phone:</strong> ${safeHtml(o.phone || '—')}</p>
            <p><strong>Email:</strong> ${safeHtml(o.email || '—')}</p>
            <p><strong>Shipping:</strong> ${safeHtml(shipping)}</p>
            <p><strong>Status:</strong> ${safeHtml(o.status || 'pending')}</p>
            <p><strong>Payment:</strong> ${safeHtml(o.payment_method || o.payment || '—')}</p>
            <p><strong>Total:</strong> ${formatMoney(totalVal)}</p>
            ${itemsHtml}
            <p style="margin-top:20px; color:#64748b;"><em>Print this page for your records.</em></p>
          </body>
        </html>
      `);
      win.document.close();
      win.print();
      win.close();
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast('Copied!');
      }catch{
        const tmp = document.createElement('textarea');
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);
        showToast('Copied!');
      }
    }

    // =========================
    // Inventory: filter + render
    // =========================
    function getFilteredProducts(){
      const term = safeLower($('productSearch')?.value || '').trim();
      const cat = safeLower($('productCategoryFilter')?.value || '').trim();
      const lowOnly = !!$('lowStockOnly')?.checked;

      return allProducts.filter(p => {
        const name = safeLower(p.name || '');
        const sku = safeLower(p.sku || '');
        const pcat = safeLower(p.category || '');

        if (term && !(name.includes(term) || sku.includes(term))) return false;
        if (cat && pcat !== cat) return false;

        if (lowOnly){
          const low = (p.low_stock_threshold != null) ? Number(p.low_stock_threshold) : 5;
          const stock = Number(p.stock_level || 0);
          if (!(stock < low)) return false;
        }

        return true;
      });
    }

    function renderInventory(products){
      const tbody = $('inventoryTbody');
      if (!tbody) return;

      if (!products || products.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:24px; color:var(--muted); font-weight:800;">
          No products match your filter.
        </td></tr>`;
        return;
      }

      tbody.innerHTML = products.map(p => {
        const low = (p.low_stock_threshold != null) ? Number(p.low_stock_threshold) : 5;
        const stock = Number(p.stock_level || 0);
        const isLow = stock < low;

        const isActive = (p.is_active == null) ? null : !!p.is_active;
        const activeHint = (isActive == null) ? '' : (isActive ? ' • Active' : ' • Disabled');

        // employees can’t remove products
        const canRemove = currentRole === 'admin';

        const catOptions = ['fruits','bakery','meat','eggs','drinks','coffee_tea_chocolate','promotions','cans_jars','pasta_rice_cereals','sauces_condiments','herbs_spices','frozen_foods','snacks','household_cleaning','personal_care'];
        const catLabels = { fruits:'Fruits & Vegetables', bakery:'Bakery & Pastry', meat:'Butcher / Meat', eggs:'Eggs & Dairy', drinks:'Drinks', coffee_tea_chocolate:'Coffee, tea & chocolate', promotions:'Promotions', cans_jars:'Cans and jars', pasta_rice_cereals:'Pasta, rice & cereals', sauces_condiments:'Sauces and condiments', herbs_spices:'Herbs and spices', frozen_foods:'Frozen foods', snacks:'Snacks', household_cleaning:'Household and cleaning', personal_care:'Personal care' };
        const catSelectOpts = catOptions.map(c => `<option value="${c}" ${(p.category||'').toLowerCase()===c?'selected':''}>${catLabels[c]||c}</option>`).join('');
        return `
          <tr data-row-id="${safeHtml(p.id)}">
            <td>
              <input class="mini-input" type="text" id="n-${safeHtml(p.id)}" value="${safeHtml(p.name || '')}" placeholder="Product name" style="font-weight:900; width:100%; min-width:140px;" />
              <div style="margin-top:6px; display:flex; align-items:center; gap:6px;">
                <select class="mini-input" id="c-${safeHtml(p.id)}" style="font-size:0.85rem; padding:6px 8px; min-width:120px;">
                  ${catSelectOpts}
                </select>
                ${activeHint ? `<span style="color:var(--muted); font-size:0.8rem;">${activeHint}</span>` : ''}
              </div>
            </td>

            <td><code class="tag">${safeHtml(p.sku || '—')}</code></td>

            <td>
              <input class="mini-input" type="number" step="0.01" min="0"
                     id="p-${safeHtml(p.id)}" value="${Number(p.price ?? 0)}" />
            </td>

            <td>
              <input class="mini-input ${isLow ? 'stock-low' : ''}" type="number" min="0"
                     id="s-${safeHtml(p.id)}" value="${Number(p.stock_level ?? 0)}" />
              ${isLow ? `<div style="margin-top:6px;"><span class="badge status-pending">LOW</span></div>` : ``}
            </td>

            <td>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button type="button" class="btn btn-green" data-action="save-product" data-id="${safeHtml(p.id)}">
                  <i class="fas fa-floppy-disk"></i> Save
                </button>

                <button type="button" class="btn btn-gray" data-action="edit-product" data-id="${safeHtml(p.id)}">
                  <i class="fas fa-pen-to-square"></i> Edit
                </button>

                ${canRemove ? `
                  <button type="button" class="btn btn-red" data-action="remove-product" data-id="${safeHtml(p.id)}" data-name="${safeHtml(p.name || 'product')}">
                    <i class="fas fa-trash-can"></i> Remove
                  </button>` : ``}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function bindInventoryFilters(){
      ['productSearch','productCategoryFilter','lowStockOnly'].forEach(id => {
        const el = $(id);
        if (!el) return;
        el.addEventListener(id === 'productSearch' ? 'input' : 'change', () => renderInventory(getFilteredProducts()));
      });
    }

    // =========================
    // Product CRUD (with soft delete if possible)
    // =========================
    async function updateProductQuick(id, row){
      // When we have the row, read inputs from it (avoids getElementById issues with UUIDs in ids)
      let nameEl, catEl, priceEl, stockEl;
      if (row && row.querySelector) {
        nameEl = row.querySelector('input[type="text"]');
        catEl = row.querySelector('select');
        priceEl = row.querySelector('input[type="number"][step="0.01"]');
        const numInputs = row.querySelectorAll('input[type="number"]');
        stockEl = Array.from(numInputs).find(function(inp){ return inp !== priceEl; }) || numInputs[0];
      }
      if (!nameEl) nameEl = document.getElementById('n-' + id);
      if (!catEl) catEl = document.getElementById('c-' + id);
      if (!priceEl) priceEl = document.getElementById('p-' + id);
      if (!stockEl) stockEl = document.getElementById('s-' + id);
      const name = nameEl ? (nameEl.value || '').trim() : '';
      const category = catEl ? (catEl.value || '').trim() : '';
      const price = priceEl ? parseFloat(priceEl.value) : 0;
      const stock = stockEl ? parseInt(stockEl.value, 10) : 0;

      if (!name) {
        alert('Product name cannot be empty.');
        return;
      }

      const payload = {
        name,
        category: category || 'fruits',
        price: Number.isFinite(price) ? price : 0,
        stock_level: Number.isFinite(stock) ? stock : 0,
        updated_at: nowIso()
      };

      const { error } = await supabase.from('products').update(payload).eq('id', id);
      if (error){
        alert('Update failed: ' + (error.message || error));
        return;
      }
      showToast('Saved');
      await loadProducts({ silent:true });
    }

    async function removeProduct(id, name){
      if (currentRole !== 'admin'){
        alert('Only admins can remove products.');
        return;
      }

      const safeName = (name || 'this product').toString().slice(0, 80);
      if (!confirm(`Remove "${safeName}"?\n\nRecommended: this will disable (soft remove) if supported.`)) return;

      // Try soft delete first (is_active=false). If the column doesn't exist, fallback to delete.
      let softOk = true;
      const softRes = await supabase.from('products').update({ is_active: false, updated_at: nowIso() }).eq('id', id);
      if (softRes.error){
        softOk = false;
      }

      if (!softOk){
        const hardRes = await supabase.from('products').delete().eq('id', id);
        if (hardRes.error){
          alert('Could not remove product: ' + (hardRes.error.message || hardRes.error));
          return;
        }
      }

      showToast('Removed');
      await loadProducts({ silent:true });
    }

    function toggleUnitWrap(category, wrapEl, unitEl, pricePerKgEl){
      const show = PER_KG_CATEGORIES.includes(String(category || '').toLowerCase());
      if (!wrapEl) return;
      wrapEl.style.display = show ? 'grid' : 'none';
      if (!show){
        if (unitEl) unitEl.value = 'unit';
        if (pricePerKgEl) pricePerKgEl.value = '';
      }
    }

    function openEditProductModal(id){
      const p = allProducts.find(x => String(x.id) === String(id));
      if (!p) return;

      $('editProductId').value = p.id;
      $('editName').value = p.name || '';
      $('editCategory').value = p.category || 'fruits';
      const editSubWrap = $('editSubcategoryWrap');
      const showEditSub = ['drinks','coffee_tea_chocolate'].includes((p.category || '').toLowerCase());
      if (editSubWrap) editSubWrap.style.display = showEditSub ? 'block' : 'none';
      if (showEditSub) fillSubcategorySelect($('editSubcategory'), p.category);
      $('editSubcategory').value = p.subcategory || '';
      $('editPrice').value = p.price ?? 0;
      $('editStock').value = p.stock_level ?? 0;

      $('editUnit').value = p.unit || 'unit';
      $('editPricePerKg').value = p.price_per_kg ?? '';
      $('editImageUrl').value = p.image_url || '';
      $('editDescription').value = p.description || '';
      $('editSku').value = p.sku || '';
      $('editVariants').value = p.variants || '';
      $('editLowStock').value = p.low_stock_threshold ?? '';

      // if supported
      if (p.is_active == null) $('editIsActive').value = 'auto';
      else $('editIsActive').value = String(!!p.is_active);

      toggleUnitWrap(p.category, $('editUnitWrap'), $('editUnit'), $('editPricePerKg'));

      const modal = $('editProductModal');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeEditProductModal(){
      const modal = $('editProductModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    async function saveEditProductForm(e){
      e.preventDefault();

      const id = $('editProductId').value;
      const category = $('editCategory').value;

      const allowPerKg = PER_KG_CATEGORIES.includes(String(category || '').toLowerCase());
      const unit = allowPerKg ? $('editUnit').value : 'unit';

      const subcategory = ($('editSubcategoryWrap')?.style?.display !== 'none') ? ($('editSubcategory').value || '').trim() || null : null;
      const payload = {
        name: $('editName').value.trim(),
        category,
        subcategory: subcategory || null,
        price: parseFloat($('editPrice').value) || 0,
        stock_level: parseInt($('editStock').value, 10) || 0,
        unit: unit || 'unit',
        image_url: ($('editImageUrl').value || '').trim() || null,
        description: ($('editDescription').value || '').trim() || null,
        sku: ($('editSku').value || '').trim() || null,
        variants: ($('editVariants').value || '').trim() || null,
        low_stock_threshold: ($('editLowStock').value || '').trim() !== '' ? parseInt($('editLowStock').value, 10) : null,
        updated_at: nowIso()
      };

      if (unit === 'kg'){
        const v = ($('editPricePerKg').value || '').trim();
        payload.price_per_kg = v !== '' ? parseFloat(v) : null;
      }

      const isActiveChoice = $('editIsActive').value;
      if (isActiveChoice === 'true') payload.is_active = true;
      if (isActiveChoice === 'false') payload.is_active = false;

      const { error } = await supabase.from('products').update(payload).eq('id', id);
      if (error){
        alert('Update failed: ' + (error.message || error));
        return;
      }

      showToast('Saved');
      closeEditProductModal();
      await loadProducts({ silent:true });
    }

    // =========================
    // Add product (admin only)
    // =========================
    async function addProduct(e){
      e.preventDefault();
      if (currentRole !== 'admin'){
        alert('Only admins can add products.');
        return;
      }

      const msgEl = $('addProductMsg');
      msgEl.textContent = 'Adding…';

      const name = $('newName').value.trim();
      const category = $('newCategory').value;
      const price = parseFloat($('newPrice').value) || 0;
      const stock = parseInt($('newStock').value, 10) || 0;

      const allowPerKg = PER_KG_CATEGORIES.includes(String(category || '').toLowerCase());
      const unit = allowPerKg ? $('newUnit').value : 'unit';
      const pricePerKg =
        (allowPerKg && unit === 'kg' && ($('newPricePerKg').value || '').trim() !== '') ?
        parseFloat($('newPricePerKg').value) : null;

      const subcategory = ($('newSubcategoryWrap').style.display !== 'none') ? ($('newSubcategory').value || '').trim() || null : null;
      const payload = {
        id: (crypto.randomUUID ? crypto.randomUUID() : ('xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/x/g, () => (Math.random()*16|0).toString(16)))),
        name,
        category,
        subcategory: subcategory || null,
        price,
        stock_level: stock,
        unit: unit || 'unit',
        image_url: ($('newImageUrl').value || '').trim() || null,
        description: ($('newDescription').value || '').trim() || null,
        sku: ($('newSku').value || '').trim() || null,
        variants: ($('newVariants').value || '').trim() || null,
        low_stock_threshold: ($('newLowStock').value || '').trim() !== '' ? parseInt($('newLowStock').value, 10) : null,
        nutritional_info: {},
        created_at: nowIso(),
        updated_at: nowIso()
      };

      if (unit === 'kg' && pricePerKg != null) payload.price_per_kg = pricePerKg;

      // if supported
      payload.is_active = true;

      if (currentUser?.id) payload.created_by = currentUser.id;

      const { error } = await supabase.from('products').insert(payload);
      if (error){
        msgEl.style.color = '#ef4444';
        msgEl.textContent = 'Error: ' + (error.message || error);
        return;
      }

      msgEl.style.color = 'var(--green)';
      msgEl.textContent = 'Product added.';
      $('addProductForm').reset();
      $('newStock').value = 0;
      toggleUnitWrap($('newCategory').value, $('unitPricePerKgWrap'), $('newUnit'), $('newPricePerKg'));

      await loadProducts({ silent:true });
    }

    // =========================
    // Bulk CSV import (admin only)
    // =========================
    function parseCSVLine(line){
      const out = [];
      let cur = '';
      let inQuotes = false;

      for (let i=0; i<line.length; i++){
        const c = line[i];
        if (c === '"'){
          // handle escaped double quotes ""
          if (inQuotes && line[i+1] === '"'){
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (c === ',' && !inQuotes){
          out.push(cur.trim());
          cur = '';
        } else {
          cur += c;
        }
      }
      out.push(cur.trim());
      return out;
    }

    async function bulkImportCSV(){
      if (currentRole !== 'admin'){
        alert('Only admins can import CSV.');
        return;
      }

      const fileInput = $('bulkCsvFile');
      const msgEl = $('bulkCsvMsg');

      if (!fileInput.files || fileInput.files.length === 0){
        msgEl.style.color = '#ef4444';
        msgEl.textContent = 'Please choose a CSV file first.';
        return;
      }

      msgEl.style.color = 'var(--muted)';
      msgEl.textContent = 'Importing…';

      let text = '';
      try{
        text = await fileInput.files[0].text();
      }catch(err){
        msgEl.style.color = '#ef4444';
        msgEl.textContent = 'Could not read file: ' + (err.message || err);
        return;
      }

      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (lines.length < 2){
        msgEl.style.color = '#ef4444';
        msgEl.textContent = 'CSV must have a header row and at least one data row.';
        return;
      }

      const headers = parseCSVLine(lines[0]).map(h => safeLower(h).replace(/\s+/g,'_'));
      const rows = [];

      for (let i=1; i<lines.length; i++){
        const vals = parseCSVLine(lines[i]);
        const r = {};
        headers.forEach((h, j) => r[h] = vals[j] ?? '');
        rows.push(r);
      }

      const payloads = rows.map(r => {
        const name = (r.name || '').trim();
        if (!name) return null;

        const id = (crypto.randomUUID ? crypto.randomUUID() : ('xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/x/g, () => (Math.random()*16|0).toString(16))));
        const category = safeLower(r.category || 'fruits').replace(/\s+/g,'_');
        const allowPerKg = PER_KG_CATEGORIES.includes(category);
        const unit = (allowPerKg && safeLower(r.unit) === 'kg') ? 'kg' : 'unit';

        const lowStock = (r.low_stock_threshold ?? '').toString().trim();
        const lowStockThreshold = lowStock !== '' ? parseInt(lowStock, 10) : null;

        const p = {
          id,
          name,
          category,
          price: parseFloat(r.price) || 0,
          stock_level: parseInt(r.stock_level, 10) || 0,
          unit,
          image_url: (r.image_url || '').trim() || null,
          description: (r.description || '').trim() || null,
          sku: (r.sku || '').trim() || null,
          variants: (r.variants || '').trim() || null,
          low_stock_threshold: (Number.isFinite(lowStockThreshold) ? lowStockThreshold : null),
          nutritional_info: {},
          is_active: true,
          created_at: nowIso(),
          updated_at: nowIso()
        };

        if (allowPerKg && unit === 'kg' && (r.price_per_kg || '').toString().trim() !== ''){
          p.price_per_kg = parseFloat(r.price_per_kg) || null;
        }

        if (currentUser?.id) p.created_by = currentUser.id;

        return p;
      }).filter(Boolean);

      // batch insert
      const BATCH = 25;
      let inserted = 0;
      let failed = 0;

      for (let i=0; i<payloads.length; i+=BATCH){
        const chunk = payloads.slice(i, i+BATCH);
        const res = await supabase.from('products').insert(chunk);
        if (res.error){
          failed += chunk.length;
          console.error('Bulk insert error', res.error);
        } else {
          inserted += chunk.length;
        }
      }

      msgEl.style.color = failed ? '#ef4444' : 'var(--green)';
      msgEl.textContent = `Done. Inserted: ${inserted}${failed ? `, failed: ${failed}` : ''}.`;
      fileInput.value = '';
      await loadProducts({ silent:true });
    }

    function downloadSampleCSV(){
      const headers = 'name,category,price,stock_level,image_url,description,unit,price_per_kg,sku,variants,low_stock_threshold';
      const rows = [
        'Organic Apples,fruits,2.99,50,https://example.com/apples.jpg,Fresh organic apples,unit,,FRUIT-001,"Size: S, M, L",5',
        'Chicken Breast,meat,4.99,18,https://example.com/chicken.jpg,Fresh chicken breast,kg,9.99,MEAT-010,,3'
      ];
      const csv = headers + '\n' + rows.join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'products_sample.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // =========================
    // Export CSV
    // =========================
    function exportOrdersCSV(){
      const rows = getFilteredOrders();
      if (!rows.length) return alert('No orders to export.');

      const headers = ['created_at','order_id','customer','phone','email','address','city','postal','total','status','payment'];
      const lines = rows.map(o => [
        o.created_at || '',
        o.id || '',
        (o.full_name || '').replace(/"/g,'""'),
        `'${o.phone || ''}`,
        (o.email || '').replace(/"/g,'""'),
        (o.address || '').replace(/"/g,'""'),
        (o.city || '').replace(/"/g,'""'),
        (o.postal || '').replace(/"/g,'""'),
        (o.total ?? o.total_price ?? 0),
        (o.status || 'pending'),
        (o.payment_method || o.payment || '')
      ].map(v => {
        const s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(','));

      const csv = headers.join(',') + '\n' + lines.join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Braga_Bazaar_Orders_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportProductsCSV(){
      const rows = getFilteredProducts();
      if (!rows.length) return alert('No products to export.');

      const headers = ["name","category","price","stock_level","image_url","description","unit","price_per_kg","sku","variants","low_stock_threshold","is_active"];
      const lines = rows.map(p => [
        p.name || '',
        p.category || '',
        p.price ?? '',
        p.stock_level ?? '',
        p.image_url || '',
        p.description || '',
        p.unit || 'unit',
        p.price_per_kg ?? '',
        p.sku || '',
        p.variants || '',
        p.low_stock_threshold ?? '',
        (p.is_active == null ? '' : (p.is_active ? 'true' : 'false'))
      ].map(v => {
        const s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(','));

      const csv = headers.join(',') + '\n' + lines.join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Braga_Bazaar_Products_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportReportCSV(){
      if (!allOrders.length) return alert('No data to export.');
      const headers = ["Date","Customer","Phone","Email","Total","Status","Payment"];
      const rows = allOrders.map(o => [
        (o.created_at ? new Date(o.created_at).toLocaleString() : ''),
        o.full_name || '',
        `'${o.phone || ''}`,
        o.email || '',
        (o.total ?? o.total_price ?? 0),
        o.status || 'pending',
        o.payment_method || o.payment || ''
      ]);

      const csv = headers.join(",") + "\n" + rows.map(r => r.map(v => {
        const s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(",")).join("\n");

      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Braga_Bazaar_Report_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // =========================
    // Bulk save visible inventory
    // =========================
    async function bulkSaveVisible(){
      const visible = getFilteredProducts();
      if (!visible.length) return;

      const updates = visible.map(p => {
        const id = p.id;
        const priceEl = document.getElementById(`p-${id}`);
        const stockEl = document.getElementById(`s-${id}`);
        if (!priceEl || !stockEl) return null;

        const price = parseFloat(priceEl.value);
        const stock = parseInt(stockEl.value, 10);

        return {
          id,
          price: Number.isFinite(price) ? price : (p.price ?? 0),
          stock_level: Number.isFinite(stock) ? stock : (p.stock_level ?? 0),
          updated_at: nowIso()
        };
      }).filter(Boolean);

      if (!updates.length) return;

      // Update sequentially to keep it simple and reliable
      let ok = 0, fail = 0;
      for (const u of updates){
        const payload = { price: u.price, stock_level: u.stock_level, updated_at: u.updated_at };

        const res = await supabase.from('products').update(payload).eq('id', u.id);
        if (res.error) fail++;
        else ok++;
      }

      showToast(`Saved visible: ${ok}${fail ? ` (failed ${fail})` : ''}`);
      await loadProducts({ silent:true });
    }

    // =========================
    // Logout
    // =========================
    async function logout(){
      try{
        await supabase.auth.signOut();
      }catch{}
      sessionStorage.removeItem(PIN_STORAGE_KEY);
      localStorage.removeItem('userIsLoggedIn');
      window.location.href = 'admin-login.html';
    }

    // =========================
    // Event delegation
    // =========================
    function bindDelegatedClicks(){
      document.addEventListener('click', async (e) => {
        const el = e.target.closest('[data-action]');
        if (!el) return;

        const action = el.getAttribute('data-action');
        const id = el.getAttribute('data-id');

        if (action === 'status'){
          const status = el.getAttribute('data-status');
          await setOrderStatus(id, status);
          return;
        }
        if (action === 'view-order'){
          openOrderModal(id);
          return;
        }
        if (action === 'print-order'){
          printInvoice(id);
          return;
        }
        if (action === 'copy-id'){
          await copyText(String(id));
          return;
        }

        // modal actions
        if (action === 'modal-status'){
          const status = el.getAttribute('data-status');
          await setOrderStatus(id, status);
          openOrderModal(id); // refresh modal content
          return;
        }
        if (action === 'modal-print'){
          printInvoice(id);
          return;
        }
        if (action === 'modal-copy'){
          await copyText(String(id));
          return;
        }

        // inventory
        if (action === 'save-product'){
          const row = el.closest('tr[data-row-id]');
          const rowId = row ? row.getAttribute('data-row-id') : id;
          await updateProductQuick(rowId, row);
          return;
        }
        if (action === 'edit-product'){
          openEditProductModal(id);
          return;
        }
        if (action === 'remove-product'){
          const name = el.getAttribute('data-name');
          await removeProduct(id, name);
          return;
        }
      });
    }

    // =========================
    // Modals bind
    // =========================
    function bindModals(){
      $('orderModalClose').addEventListener('click', closeOrderModal);
      $('orderModal').addEventListener('click', (e) => { if (e.target === $('orderModal')) closeOrderModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeOrderModal(); closeEditProductModal(); } });

      $('editModalClose').addEventListener('click', closeEditProductModal);
      $('editCancelBtn').addEventListener('click', closeEditProductModal);
      $('editProductModal').addEventListener('click', (e) => { if (e.target === $('editProductModal')) closeEditProductModal(); });

      $('editCategory').addEventListener('change', () => {
        toggleUnitWrap($('editCategory').value, $('editUnitWrap'), $('editUnit'), $('editPricePerKg'));
        const wrap = $('editSubcategoryWrap');
        const cat = ($('editCategory').value || '').toLowerCase();
        const show = ['drinks','coffee_tea_chocolate'].includes(cat);
        if (wrap) wrap.style.display = show ? 'block' : 'none';
        if (show) fillSubcategorySelect($('editSubcategory'), cat);
      });
      $('editProductForm').addEventListener('submit', saveEditProductForm);
    }

    // =========================
    // Bind buttons + init
    // =========================
    function bindButtons(){
      $('logoutBtn').addEventListener('click', logout);

      $('refreshOrdersBtn').addEventListener('click', async () => { await loadOrders(); showToast('Orders refreshed'); });
      $('refreshProductsBtn').addEventListener('click', async () => { await loadProducts(); showToast('Products refreshed'); });

      $('exportOrdersBtn').addEventListener('click', exportOrdersCSV);
      $('exportProductsBtn').addEventListener('click', exportProductsCSV);
      $('exportReportBtn').addEventListener('click', exportReportCSV);

      $('bulkSaveVisibleBtn').addEventListener('click', bulkSaveVisible);

      // Add product
      $('addProductForm').addEventListener('submit', addProduct);
      $('addProductResetBtn').addEventListener('click', () => { $('addProductForm').reset(); $('newStock').value = 0; $('addProductMsg').textContent=''; });

      // Unit wrap toggle (add)
      function toggleSubcategoryWrap(){
        const cat = ($('newCategory')?.value || '').toLowerCase();
        const wrap = $('newSubcategoryWrap');
        const show = (cat === 'drinks' || cat === 'coffee_tea_chocolate');
        if (wrap) wrap.style.display = show ? 'block' : 'none';
        if (show) fillSubcategorySelect($('newSubcategory'), cat);
      }
      $('newCategory').addEventListener('change', () => {
        toggleUnitWrap($('newCategory').value, $('unitPricePerKgWrap'), $('newUnit'), $('newPricePerKg'));
        toggleSubcategoryWrap();
      });
      toggleUnitWrap($('newCategory').value, $('unitPricePerKgWrap'), $('newUnit'), $('newPricePerKg'));
      toggleSubcategoryWrap();

      // Bulk import
      $('bulkCsvBtn').addEventListener('click', bulkImportCSV);
      $('sampleCsvBtn').addEventListener('click', downloadSampleCSV);
    }

    function boot(){
      bindOnlineState();
      bindTabs();
      bindOrderFilters();
      bindInventoryFilters();
      bindButtons();
      bindDelegatedClicks();
      bindModals();

      // fast initial render from cache
      const cachedOrders = cacheRead(CACHE_ORDERS_KEY);
      if (cachedOrders){ allOrders = cachedOrders; renderOrders(getFilteredOrders()); updateReportStats(); }

      const cachedProducts = cacheRead(CACHE_PRODUCTS_KEY);
      if (cachedProducts){ allProducts = cachedProducts; renderInventory(getFilteredProducts()); }

      // fetch fresh
      loadAll();
    }

    // Start
    adminGate();
  </script>
</body>
</html>
