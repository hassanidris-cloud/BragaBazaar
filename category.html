<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braga Bazaar | Categorias</title>
    <link rel="icon" type="image/svg+xml" href="assets/braga-bazaar-logo.svg">
    <link rel="apple-touch-icon" href="assets/braga-bazaar-logo.svg">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="global.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Toast Notification Style */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #2d7a32; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed;
            z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Sidebar & Layout Fixes */
        .main-header .site-nav a.site-nav-icon-only { color: #000 !important; }
        .nav-item.active { background: #f0f0f0; border-left: 4px solid #2d7a32; font-weight: 600; }
        .sidebar-nav button { 
            width: 100%; background: none; border: none; text-align: left; 
            padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-family: inherit; font-size: 1rem;
        }

        /* Ensure the sidebar moves when 'active' is added */
        #sidebar.active {
            transform: translateX(0) !important;
            visibility: visible !important;
            display: block !important;
        }

        /* Ensure main content doesn't overlap the sidebar when it's open */
        @media (max-width: 768px) {
            #sidebar {
                z-index: 9999 !important; /* Make it the absolute top layer */
            }
        }
    </style>
</head>
<body>
    <script type="module">
      import { supabase, ADMIN_ONLY_EMAILS } from './supabaseConfig.js';
      const { data: { session } } = await supabase.auth.getSession();
      const email = (session?.user?.email || '').toLowerCase();
      if (session && Array.isArray(ADMIN_ONLY_EMAILS) && ADMIN_ONLY_EMAILS.some(e => (e || '').toLowerCase() === email)) {
        window.location.href = 'admin.html';
      }
    </script>
    <div id="toast">Produto adicionado!</div>

    <aside class="sidebar-menu" id="sidebar">
        <nav class="sidebar-nav">
            <button onclick="switchCategory('fruits', 'Frutas e Vegetais')" class="nav-item" data-category="fruits"><i class="fas fa-apple-alt"></i> <span>Frutas e Vegetais</span></button>
            <button onclick="switchCategory('bakery', 'Padaria e Pastelaria')" class="nav-item" data-category="bakery"><i class="fas fa-bread-slice"></i> <span>Padaria</span></button>
            <button onclick="switchCategory('meat', 'Talho')" class="nav-item" data-category="meat"><i class="fas fa-drumstick-bite"></i> <span>Talho</span></button>
            <button onclick="switchCategory('eggs', 'Ovos e Lacticínios')" class="nav-item" data-category="eggs"><i class="fas fa-egg"></i> <span>Ovos e Lacticínios</span></button>
            <button onclick="switchCategory('drinks', 'Bebidas')" class="nav-item" data-category="drinks"><i class="fas fa-wine-bottle"></i> <span>Bebidas</span></button>
            <button onclick="switchCategory('coffee_tea_chocolate', 'Café, chá e chocolate')" class="nav-item" data-category="coffee_tea_chocolate"><i class="fas fa-mug-hot"></i> <span>Café, chá e chocolate</span></button>
            <button onclick="switchCategory('cans_jars', 'Latas e frascos')" class="nav-item" data-category="cans_jars"><i class="fas fa-box"></i> <span>Latas e frascos</span></button>
            <button onclick="switchCategory('pasta_rice_cereals', 'Massas, arroz e cereais')" class="nav-item" data-category="pasta_rice_cereals"><i class="fas fa-utensils"></i> <span>Massas, arroz e cereais</span></button>
            <button onclick="switchCategory('sauces_condiments', 'Molhos e condimentos')" class="nav-item" data-category="sauces_condiments"><i class="fas fa-flask"></i> <span>Molhos e condimentos</span></button>
            <button onclick="switchCategory('herbs_spices', 'Ervas e especiarias')" class="nav-item" data-category="herbs_spices"><i class="fas fa-leaf"></i> <span>Ervas e especiarias</span></button>
            <button onclick="switchCategory('frozen_foods', 'Congelados')" class="nav-item" data-category="frozen_foods"><i class="fas fa-snowflake"></i> <span>Congelados</span></button>
            <button onclick="switchCategory('snacks', 'Snacks')" class="nav-item" data-category="snacks"><i class="fas fa-cookie-bite"></i> <span>Snacks</span></button>
            <button onclick="switchCategory('household_cleaning', 'Casa e limpeza')" class="nav-item" data-category="household_cleaning"><i class="fas fa-broom"></i> <span>Casa e limpeza</span></button>
            <button onclick="switchCategory('personal_care', 'Higiene e beleza')" class="nav-item" data-category="personal_care"><i class="fas fa-spa"></i> <span>Higiene e beleza</span></button>
        </nav>
    </aside>

    <button type="button" class="sidebar-backdrop" id="sidebarBackdrop" aria-label="Fechar menu" style="display:none;"></button>

    <div id="main-content">
        <header class="main-header">
            <div class="top-nav">
                <button type="button" class="menu-reopen-btn" onclick="openSidebarMobile()"><i class="fas fa-bars"></i></button>
                <a href="index.html" class="logo">BRAGA<span>BAZAAR</span></a>
                <nav class="site-nav">
                    <a href="index.html" class="site-nav-icon-only"><i class="fas fa-store"></i></a>
                    <a href="checkout.html" class="site-nav-icon-only">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="headerPrice">0.00</span>€
                    </a>
                </nav>
            </div>
        </header>

        <div class="category-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;padding:20px 5%;">
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <h1 class="breadcrumb" style="font-size: 1.2rem;margin:0;">Produtos / <span id="categoryName" style="color:#2d7a32;">Frutas</span></h1>
                <div id="subcategoryDropdownWrap" style="display:none;">
                    <label for="subcategorySelect" style="font-size:0.9rem;font-weight:600;color:#64748b;">Filtrar: </label>
                    <select id="subcategorySelect" style="padding:8px 12px;border-radius:10px;border:1px solid #e2e8f0;font-size:0.95rem;margin-left:8px;">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <a href="index.html" class="cta-secondary" style="text-decoration:none; padding:8px 15px; border-radius:20px;">&larr; Voltar</a>
        </div>

        <div class="container">
            <div class="product-grid" id="productGrid">
                </div>
        </div>
    </div>

    <script>
        let cart = JSON.parse(localStorage.getItem('bragaBazaarCart')) || [];

        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        function updateHeader() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('headerPrice').innerText = total.toFixed(2);
        }

        function addToCart(name, price) {
            const existing = cart.find(item => item.name === name);
            if (existing) { existing.qty += 1; } 
            else { cart.push({ name, qty: 1, price: parseFloat(price) }); }
            
            localStorage.setItem('bragaBazaarCart', JSON.stringify(cart));
            updateHeader();
            showToast(`${name} adicionado ao carrinho!`);
        }

        const productsData = {
            fruits: [
                { name: "Morangos", price: 2.49, img: "assets/morangos.jpg" },
                { name: "Maçã Regional", price: 1.80, img: "assets/maca.jpg" }
            ],
            bakery: [
                { name: "Pão de Mafra", price: 1.20, img: "assets/pao.jpg" },
                { name: "Croissant", price: 0.90, img: "assets/croissant.jpg" }
            ],
            eggs: [
                { name: "Ovos Caseiros", price: 2.10, img: "assets/ovos.jpg" }
            ],
            drinks: [
                { name: "Água Mineral", price: 0.79, img: "assets/strawberries.jpg", subcategory: "waters" },
                { name: "Água com Gás", price: 0.89, img: "assets/strawberries.jpg", subcategory: "waters" },
                { name: "Sumo de Laranja", price: 1.49, img: "assets/strawberries.jpg", subcategory: "juices_softdrinks" },
                { name: "Coca-Cola", price: 1.29, img: "assets/strawberries.jpg", subcategory: "juices_softdrinks" }
            ],
            coffee_tea_chocolate: []
        };

        const SUB_CATEGORIES = {
            drinks: ['waters', 'juices_softdrinks'],
            coffee_tea_chocolate: ['coffee_capsules', 'ground_coffee_grain', 'soluble_decaf', 'tea_infusions', 'cereal_drinks', 'chocolate_milk']
        };
        const SUB_CAT_LABELS = {
            waters: 'Águas',
            juices_softdrinks: 'Sumos e Refrigerantes',
            coffee_capsules: 'Cápsulas de café',
            ground_coffee_grain: 'Café em pó e em grão',
            soluble_decaf: 'Café solúvel e descafeinado',
            tea_infusions: 'Chá e infusões',
            cereal_drinks: 'Bebidas de cereais',
            chocolate_milk: 'Leite com chocolate'
        };

        function renderCategoryItems(items, subcatFilter) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = "";
            const filtered = subcatFilter
                ? items.filter(i => (i.subcategory || '').toLowerCase() === subcatFilter.toLowerCase())
                : items;
            if (filtered.length === 0) {
                grid.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>Em breve teremos produtos aqui!</p>";
                return;
            }
            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.setAttribute('data-subcategory', (item.subcategory || '').toLowerCase());
                card.innerHTML = `
                    <img src="${item.img}" alt="${item.name}" onerror="this.src='https://placehold.co/400x400?text=Braga+Bazaar'">
                    <h3>${item.name}</h3>
                    <p class="price">€${item.price.toFixed(2)}</p>
                    <button class="add-btn" onclick="addToCart('${item.name}', ${item.price})">Adicionar</button>
                `;
                grid.appendChild(card);
            });
        }

        function switchCategory(type, displayName) {
            const grid = document.getElementById('productGrid');
            const catTitle = document.getElementById('categoryName');
            const dropWrap = document.getElementById('subcategoryDropdownWrap');
            const subSelect = document.getElementById('subcategorySelect');

            catTitle.innerText = displayName;

            const hasSubcats = SUB_CATEGORIES && SUB_CATEGORIES[type];
            if (dropWrap) dropWrap.style.display = hasSubcats ? 'block' : 'none';
            if (subSelect) {
                subSelect.value = '';
                subSelect.onchange = null;
                if (hasSubcats && SUB_CATEGORIES[type]) {
                    subSelect.innerHTML = '<option value="">Todos</option>';
                    SUB_CATEGORIES[type].forEach(function(sc) {
                        const opt = document.createElement('option');
                        opt.value = sc;
                        opt.textContent = SUB_CAT_LABELS[sc] || sc;
                        subSelect.appendChild(opt);
                    });
                }
            }

            const items = productsData[type] || [];
            renderCategoryItems(items, '');

            if (hasSubcats && subSelect) {
                subSelect.onchange = () => renderCategoryItems(items, subSelect.value || '');
            }

            highlightNav(type);
            if (window.innerWidth <= 768) closeSidebarMobile();
        }

        function highlightNav(type) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-category') === type);
            });
        }

        function openSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');

            sidebar.classList.add('active');
            if (backdrop) {
                backdrop.style.display = 'block';
                backdrop.style.opacity = '1';
            }
            document.body.style.overflow = 'hidden'; // Stop page scroll
        }

        function closeSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');

            sidebar.classList.remove('active');
            if (backdrop) {
                backdrop.style.display = 'none';
                backdrop.style.opacity = '0';
            }
            document.body.style.overflow = ''; // Allow page scroll
        }

        // Keep toggleSidebar for compatibility if needed elsewhere
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active')) {
                closeSidebarMobile();
            } else {
                openSidebarMobile();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const backdrop = document.getElementById('sidebarBackdrop');
            if (backdrop) backdrop.addEventListener('click', closeSidebarMobile);
        });

        window.onload = () => {
            updateHeader();
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type') || 'fruits';
            const labels = { fruits: 'Frutas e Vegetais', bakery: 'Padaria', eggs: 'Ovos e Lacticínios', meat: 'Talho', drinks: 'Bebidas', coffee_tea_chocolate: 'Café, chá e chocolate', cans_jars: 'Latas e frascos', pasta_rice_cereals: 'Massas, arroz e cereais', sauces_condiments: 'Molhos e condimentos', herbs_spices: 'Ervas e especiarias', frozen_foods: 'Congelados', snacks: 'Snacks', household_cleaning: 'Casa e limpeza', personal_care: 'Higiene e beleza' };
            switchCategory(type, labels[type] || 'Produtos');
        };
    </script>
</body>
</html>