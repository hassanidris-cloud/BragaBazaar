<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2d7a32">
    <meta name="description" content="Complete your Braga Bazaar order. Delivery or pickup in Braga. Secure payment.">
    <title>Checkout | Braga Bazaar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style type="text/css">.main-header .site-nav a.site-nav-icon-only,.main-header .site-nav a.site-nav-icon-only i,.main-header .site-nav a.site-nav-icon-only .site-nav-cart-total{color:#000!important}.main-header .site-nav a.site-nav-icon-only:link,.main-header .site-nav a.site-nav-icon-only:visited,.main-header .site-nav a.site-nav-icon-only:hover,.main-header .site-nav a.site-nav-icon-only:focus{color:#000!important}.main-header .site-nav a.site-nav-icon-only:hover i,.main-header .site-nav a.site-nav-icon-only:focus i{color:#000!important}</style>
    <style>
        body { background: #fff; font-family: 'Inter', sans-serif; }
        .checkout-container { display: flex; max-width: 900px; margin: 60px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }
        .checkout-form { flex: 1; padding: 32px; }
        .order-summary { flex: 1; padding: 32px; border-left: 1px solid #eee; }
        .checkout-form h2, .order-summary h2 { color: #4a6d1a; margin-bottom: 24px; }
        .checkout-form label { font-weight: bold; color: #333; margin-top: 12px; display: block; }
        .checkout-form input, .checkout-form textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-top: 6px; margin-bottom: 16px; box-sizing: border-box; }
        .checkout-form textarea { min-height: 60px; }
        .checkout-form .payment-methods { margin-bottom: 24px; }
        .checkout-form .payment-methods label { display: inline-block; margin-right: 18px; }
        .checkout-form .cta-primary { border-radius: 20px; padding: 12px 32px; width: 100%; margin-top: 12px; }
        .breadcrumb { color: #4a6d1a; margin-bottom: 18px; font-weight: bold; }
        @media (max-width: 768px) {
          .checkout-container { flex-direction: column; margin: 18px auto !important; }
          .checkout-form, .order-summary { padding: 18px !important; }
          .order-summary { border-left: none; border-top: 1px solid #eee; }
        }
        /* Order summary: product image + name + qty + price */
        #orderItems { list-style: none; margin: 0; padding: 0; }
        .order-summary-item {
          display: flex;
          align-items: center;
          gap: 14px;
          padding: 12px 0;
          border-bottom: 1px solid #eee;
        }
        .order-summary-item:last-child { border-bottom: none; }
        .order-summary-item img {
          width: 56px;
          height: 56px;
          object-fit: cover;
          border-radius: 10px;
          background: #f1f5f9;
        }
        .order-summary-item-info { flex: 1; min-width: 0; }
        .order-summary-item-name { font-weight: 700; color: #1e293b; display: block; margin-bottom: 4px; }
        .order-summary-item-meta { font-size: 0.85rem; color: #64748b; }
        .order-summary-item-price { font-weight: 800; color: #2d7a32; white-space: nowrap; }
    </style>
</head>
<body>
    <header class="main-header shared-header">
        <div class="top-nav">
            <a href="index.html" class="logo">BRAGA<span>BAZAAR</span></a>
            <form class="search-bar" action="index.html" method="get" role="search">
                <input type="search" name="q" placeholder="O que procura?" aria-label="Search products">
                <button type="submit">Pesquisar</button>
            </form>
            <nav class="site-nav" aria-label="Main navigation">
                <a href="index.html" class="site-nav-icon-only" title="Shop" aria-label="Shop"><i class="fas fa-store"></i></a>
                <a href="orders.html" class="site-nav-icon-only" title="My orders" aria-label="My orders"><i class="fas fa-clipboard-list"></i><span class="site-nav-label">As minhas encomendas</span></a>
                <a href="contact.html" class="site-nav-icon-only" title="Contact" aria-label="Contact"><i class="fas fa-envelope"></i></a>
                <a href="account.html" class="site-nav-icon-only" title="My account" aria-label="My account"><i class="fas fa-user"></i></a>
                <a href="checkout.html" class="site-nav-icon-only site-nav-current" title="Cart" aria-label="Cart"><i class="fas fa-shopping-cart"></i></a>
            </nav>
        </div>
    </header>
    <div class="checkout-container">
        <div class="checkout-form">
            <div class="breadcrumb">Carrinho &gt; Conta &gt; Checkout</div>

            <div id="authGate" style="display:none; background:#f8fafc; border:1px solid #e2e8f0; padding:14px; border-radius:12px; margin: 12px 0 18px;">
              <p style="margin:0 0 10px; font-weight:800; color:#0f172a;">
                Já tem conta?
              </p>
              <p style="margin:0 0 12px; color:#475569; font-weight:600; font-size:0.95rem;">
                Inicie sessão para finalizar a encomenda. Se ainda não tem conta, crie uma — demora 1 minuto.
              </p>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <a id="goLoginBtn" class="cta-primary" style="display:inline-flex; align-items:center; justify-content:center; padding:10px 16px; border-radius:12px; background:#2d7a32; color:#fff; font-weight:800; text-decoration:none;">
                  Entrar
                </a>
                <a id="goSignupBtn" style="display:inline-flex; align-items:center; justify-content:center; padding:10px 16px; border-radius:12px; background:#fff; color:#2d7a32; border:2px solid #2d7a32; font-weight:800; text-decoration:none;">
                  Criar conta
                </a>
                <button id="continueGuestBtn" type="button" style="display:inline-flex; align-items:center; justify-content:center; padding:10px 16px; border-radius:12px; background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0; font-weight:800; cursor:pointer;">
                  Continuar a ver carrinho
                </button>
              </div>

              <p style="margin:12px 0 0; color:#64748b; font-size:0.85rem; font-weight:600;">
                Nota: Para fazer a encomenda, precisa de estar com sessão iniciada.
              </p>
            </div>

            <p id="checkoutSavedNotice" style="display:none; background:#e8f5e9; color:#2d7a32; padding:12px; border-radius:8px; margin-bottom:16px; font-weight:600;"></p>
            <h2>Entrega</h2>
            <form id="deliveryForm">
                <label for="fullName">Nome Completo</label>
                <input type="text" id="fullName" required aria-describedby="err-fullName">
                <span class="field-error" id="err-fullName" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="phone">Telemóvel</label>
                <input type="tel" id="phone" required aria-describedby="err-phone">
                <span class="field-error" id="err-phone" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="email">Email</label>
                <input type="email" id="email" required aria-describedby="err-email">
                <span class="field-error" id="err-email" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <p id="pickupNote" style="display:none;background:#f0fdf4;color:#166534;padding:10px 12px;border-radius:8px;font-size:0.9rem;margin-bottom:12px;">Para levantamento na loja, morada não é obrigatória. Loja: R. Conselheiro Lobato 368, 4705-089 Braga. Horário: 9h–22h.</p>
                <label for="address">Morada</label>
                <input type="text" id="address" required>
                <span class="field-error" id="err-address" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="postal">Código Postal (Braga)</label>
                <input type="text" id="postal" required>
                <span class="field-error" id="err-postal" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="city">Cidade</label>
                <input type="text" id="city" required>
                <span class="field-error" id="err-city" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="location">Freguesia / Localização</label>
                <input type="text" id="location" required>
                <span class="field-error" id="err-location" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="country">País</label>
                <select id="country" required aria-describedby="err-country">
                    <option value="Portugal">Portugal</option>
                    <option value="Spain">Spain / Espanha</option>
                    <option value="France">France / França</option>
                    <option value="United Kingdom">United Kingdom</option>
                    <option value="Germany">Germany / Alemanha</option>
                    <option value="Other">Other / Outro</option>
                </select>
                <span class="field-error" id="err-country" style="display:none;color:#dc2626;font-size:0.85rem;"></span>

                <label for="instructions">Instruções de Entrega</label>
                <textarea id="instructions" placeholder="Ex: Porta do prédio, código do prédio..."></textarea>

                <label style="margin-top:16px;display:block;">Tipo de receção</label>
                <div class="payment-methods">
                    <label><input type="radio" name="fulfillment" value="delivery" checked> Entrega ao domicílio</label>
                    <label><input type="radio" name="fulfillment" value="pickup"> Levantamento na loja</label>
                </div>
                <script>
                (function () {
                    function setPickupFields() {
                        var isPickup = document.querySelector('input[name="fulfillment"]:checked').value === 'pickup';
                        var note = document.getElementById('pickupNote');
                        if (note) note.style.display = isPickup ? 'block' : 'none';
                        ['address','postal','city','location'].forEach(function (id) {
                            var el = document.getElementById(id);
                            if (el) el.required = !isPickup;
                        });
                    }
                    document.querySelectorAll('input[name="fulfillment"]').forEach(function (r) {
                        r.addEventListener('change', setPickupFields);
                    });
                    setPickupFields();
                })();
                </script>
                <div class="payment-methods" style="margin-top:20px;">
                    <label><input type="radio" name="payment" value="mbway" required> MB Way</label>
                    <label><input type="radio" name="payment" value="card"> Cartão de Crédito</label>
                    <label><input type="radio" name="payment" value="cash"> Pagamento na Entrega</label>
                </div>
                <div id="checkoutError" style="display:none; margin:10px 0; padding:10px; border:1px solid #ffb3b3; background:#fff0f0; color:#7a0000; border-radius:8px;"></div>
                <button id="placeOrderBtn" type="submit" class="cta-primary" style="border:none;cursor:pointer;width:100%;background:#2d7a32;color:#fff;font-weight:600;">Fazer encomenda</button>
            </form>
        </div>
        <div class="order-summary">
            <h2>Resumo da Encomenda</h2>
            <ul id="orderItems"></ul>
            <div id="orderTotal" style="margin-top:20px;font-weight:bold;color:#4a6d1a;"></div>
        </div>
    </div>

    <div id="orderConfirmation" style="display:none;max-width:560px;margin:60px auto;padding:32px;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);text-align:center;">
        <h2 style="color:#2d7a32;margin-bottom:16px;">Encomenda confirmada</h2>
        <p id="confirmationMessage" style="color:#475569;margin-bottom:24px;"></p>
        <p style="font-size:0.9rem;color:#64748b;">Enviámos um email de confirmação com o resumo da encomenda.</p>
        <p style="margin-top:16px;"><a href="orders.html" style="color:#2d7a32;font-weight:600;">Ver as minhas encomendas</a></p>
        <a href="index.html" class="cta-primary" style="display:inline-block;margin-top:24px;padding:12px 24px;border-radius:12px;text-decoration:none;color:#fff;font-weight:600;">Continuar a comprar</a>
    </div>

    <script type="module">
        import { supabase, ADMIN_ONLY_EMAILS } from './supabaseConfig.js';

        function showCheckoutError(msg) {
            const el = document.getElementById('checkoutError');
            if (el) {
                el.textContent = msg;
                el.style.display = 'block';
            } else {
                alert(msg);
            }
        }

        function setSubmitLoading(isLoading) {
            const btn = document.getElementById('placeOrderBtn');
            if (!btn) return;
            btn.disabled = isLoading;
            btn.dataset.originalText = btn.dataset.originalText || btn.textContent;
            btn.textContent = isLoading ? 'A enviar...' : btn.dataset.originalText;
        }

        // --- Auth gate (Option 1): show checkout + cart, but block placing order until login ---
        const { data: { session } } = await supabase.auth.getSession();

        const authGate = document.getElementById('authGate');
        const formEl = document.getElementById('deliveryForm');
        const placeBtn = document.getElementById('placeOrderBtn');

        const redirectUrl = encodeURIComponent('checkout.html');
        const goLoginBtn = document.getElementById('goLoginBtn');
        const goSignupBtn = document.getElementById('goSignupBtn');
        const continueGuestBtn = document.getElementById('continueGuestBtn');

        if (goLoginBtn) goLoginBtn.href = `login.html?redirect=${redirectUrl}`;
        if (goSignupBtn) goSignupBtn.href = `signup.html?redirect=${redirectUrl}`;
        if (goSignupBtn) goSignupBtn.addEventListener('click', function () { saveCheckoutDraft(); });
        if (goLoginBtn) goLoginBtn.addEventListener('click', function () { saveCheckoutDraft(); });
        if (continueGuestBtn) continueGuestBtn.addEventListener('click', () => { if (authGate) authGate.style.display = 'none'; });

        function saveCheckoutDraft() {
            const form = document.getElementById('deliveryForm');
            if (!form) return;
            const draft = {
                fullName: document.getElementById('fullName')?.value?.trim(),
                phone: document.getElementById('phone')?.value?.trim(),
                email: document.getElementById('email')?.value?.trim(),
                address: document.getElementById('address')?.value?.trim(),
                postal: document.getElementById('postal')?.value?.trim(),
                city: document.getElementById('city')?.value?.trim(),
                location: document.getElementById('location')?.value?.trim(),
                country: document.getElementById('country')?.value?.trim(),
                instructions: document.getElementById('instructions')?.value?.trim()
            };
            localStorage.setItem('bragaBazaarCheckoutDraft', JSON.stringify(draft));
        }

        const isLoggedIn = !!session;

        if (!isLoggedIn) {
            if (authGate) authGate.style.display = 'block';

            if (placeBtn) {
                placeBtn.disabled = true;
                placeBtn.style.opacity = '0.65';
                placeBtn.style.cursor = 'not-allowed';
                placeBtn.textContent = 'Entre para finalizar';
            }

            if (formEl) {
                formEl.addEventListener('submit', (e) => {
                    e.preventDefault();
                    showCheckoutError('Por favor, inicie sessão para finalizar a encomenda.');
                    authGate?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }
        } else {
            const email = (session.user?.email || '').toLowerCase();
            if (Array.isArray(ADMIN_ONLY_EMAILS) && ADMIN_ONLY_EMAILS.some(e => (e || '').toLowerCase() === email)) {
                window.location.href = 'admin.html';
                throw new Error('Admin-only: redirecting');
            }
        }

        // Load cart from localStorage and render order summary with image, name, qty, price
        const cart = JSON.parse(localStorage.getItem('bragaBazaarCart') || '[]');
        const orderItems = document.getElementById('orderItems');
        const noImagePlaceholder = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 56 56"><rect fill="#e2e8f0" width="56" height="56"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-size="12">?</text></svg>');
        let total = 0;
        cart.forEach(item => {
            const qty = Number(item.qty) || 1;
            const price = Number(item.price) || 0;
            const lineTotal = price * qty;
            total += lineTotal;
            const imgSrc = (item.image_url && String(item.image_url).trim()) ? item.image_url.trim() : noImagePlaceholder;
            const imgSrcAttr = imgSrc.replace(/"/g, '&quot;');
            const name = (item.name || 'Produto').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            const subNote = (item.substitution === 'no') ? ' <span style="font-size:0.8rem;color:#64748b;">(não substituir)</span>' : '';
            const li = document.createElement('li');
            li.className = 'order-summary-item';
            li.innerHTML = '<img src="' + imgSrcAttr + '" alt="" loading="lazy" onerror="this.onerror=null;if(this.dataset.fb)this.src=this.dataset.fb" data-fb="' + noImagePlaceholder.replace(/"/g, '&quot;') + '">' +
                '<div class="order-summary-item-info">' +
                '<span class="order-summary-item-name">' + name + subNote + '</span>' +
                '<span class="order-summary-item-meta">' + qty + ' × €' + price.toFixed(2) + '</span>' +
                '</div>' +
                '<span class="order-summary-item-price">€' + lineTotal.toFixed(2) + '</span>';
            orderItems.appendChild(li);
        });
        const orderTotalEl = document.getElementById('orderTotal');
        if (orderTotalEl) orderTotalEl.innerHTML = cart.length ? '<strong>Total: €' + total.toFixed(2) + '</strong>' : '<span style="color:#64748b;">O seu carrinho está vazio. <a href="index.html">Adicione produtos</a>.</span>';

        if (window.innerWidth <= 768) {
            document.querySelector('.checkout-container')?.scrollIntoView({ behavior: 'auto', block: 'start' });
        }

        // Prefill customer info: first from signup/login (bragaBazaarUser), then overlay draft if any
        const storedUserRaw = localStorage.getItem('bragaBazaarUser');
        const draftRaw = localStorage.getItem('bragaBazaarCheckoutDraft');
        const isLoggedIn = localStorage.getItem('userIsLoggedIn') === 'true';

        function setFormValue(id, value) {
            const el = document.getElementById(id);
            if (el && value !== undefined && value !== null && String(value).trim() !== '') el.value = String(value).trim();
        }

        if (storedUserRaw) {
            try {
                const user = JSON.parse(storedUserRaw);
                if (user.fullName) setFormValue('fullName', user.fullName);
                if (user.phone) setFormValue('phone', user.phone);
                if (user.email) setFormValue('email', user.email);
                if (user.address) setFormValue('address', user.address);
                if (user.postal) setFormValue('postal', user.postal);
                if (user.city) setFormValue('city', user.city);
                if (user.location) setFormValue('location', user.location);
                if (user.country) setFormValue('country', user.country);
                var notice = document.getElementById('checkoutSavedNotice');
                if (notice && isLoggedIn && user.fullName) {
                    notice.style.display = 'block';
                    var lang = localStorage.getItem('preferredLang') || 'pt';
                    notice.textContent = lang === 'en' ? 'Your details are saved. Review and confirm below, then pay.' : 'Os seus dados estão guardados. Revise e confirme abaixo, depois pague.';
                }
            } catch (_) {}
        }
        if (draftRaw) {
            try {
                const draft = JSON.parse(draftRaw);
                if (draft.fullName) setFormValue('fullName', draft.fullName);
                if (draft.phone) setFormValue('phone', draft.phone);
                if (draft.email) setFormValue('email', draft.email);
                if (draft.address) setFormValue('address', draft.address);
                if (draft.postal) setFormValue('postal', draft.postal);
                if (draft.city) setFormValue('city', draft.city);
                if (draft.location) setFormValue('location', draft.location);
                if (draft.country) setFormValue('country', draft.country);
                if (draft.instructions) setFormValue('instructions', draft.instructions);
                localStorage.removeItem('bragaBazaarCheckoutDraft');
            } catch (_) {}
        }

        let isSubmitting = false;
        const form = document.getElementById('deliveryForm');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSubmitting) return;

            const errEl = document.getElementById('checkoutError');
            if (errEl) errEl.style.display = 'none';
            document.querySelectorAll('.field-error').forEach(el => { el.style.display = 'none'; el.textContent = ''; });

            const { data: { session: submitSession } } = await supabase.auth.getSession();
            if (!submitSession) {
                showCheckoutError('Tem de iniciar sessão para colocar uma encomenda.');
                const authGateEl = document.getElementById('authGate');
                if (authGateEl) {
                    authGateEl.style.display = 'block';
                    authGateEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                return;
            }

            isSubmitting = true;
            setSubmitLoading(true);

            try {
                const cart = JSON.parse(localStorage.getItem('bragaBazaarCart') || '[]');
                if (!cart.length) {
                    throw new Error('O carrinho está vazio.');
                }

                const full_name = document.getElementById('fullName')?.value?.trim();
                const phone = document.getElementById('phone')?.value?.trim();
                const email = document.getElementById('email')?.value?.trim();
                const address = document.getElementById('address')?.value?.trim();
                const postal = document.getElementById('postal')?.value?.trim();
                const city = document.getElementById('city')?.value?.trim();
                const location = document.getElementById('location')?.value?.trim();
                const country = document.getElementById('country')?.value?.trim() || 'Portugal';
                const payment = document.querySelector('input[name="payment"]:checked')?.value || 'cash';
                const fulfillment = document.querySelector('input[name="fulfillment"]:checked')?.value || 'delivery';
                const instructions = document.getElementById('instructions')?.value?.trim() || '';

                if (!full_name) throw new Error('Por favor, introduza o seu nome.');
                if (!phone) throw new Error('Por favor, introduza o seu telefone.');
                if (!email) throw new Error('Por favor, introduza o seu email.');
                if (fulfillment === 'delivery' && !address) throw new Error('Por favor, introduza a sua morada para entrega.');

                const total = cart.reduce((sum, item) => sum + (Number(item.price) * Number(item.qty || 1)), 0);
                const client_order_id = Date.now();

                const { data: orderRow, error: orderErr } = await supabase
                    .from('orders')
                    .insert([{
                        client_order_id,
                        full_name,
                        phone,
                        email,
                        address,
                        postal,
                        city,
                        location,
                        country,
                        payment,
                        payment_method: payment,
                        instructions,
                        fulfillment,
                        total,
                        total_price: total,
                        status: 'pending',
                    }])
                    .select('id')
                    .single();

                if (orderErr) {
                    throw new Error(orderErr.message || 'Falha ao criar encomenda.');
                }

                const order_id = orderRow.id;
                const itemsPayload = cart.map(it => ({
                    order_id,
                    name: it.name,
                    price: Number(it.price),
                    qty: Number(it.qty || 1),
                    quantity: Number(it.qty || 1),
                }));

                const { error: itemsErr } = await supabase.from('order_items').insert(itemsPayload);
                if (itemsErr) {
                    throw new Error(itemsErr.message || 'Encomenda criada, mas falha ao guardar itens.');
                }

                for (const item of cart) {
                    if (!item.productId) continue;
                    try {
                        const { data: prod, error: prodErr } = await supabase
                            .from('products')
                            .select('stock_level')
                            .eq('id', item.productId)
                            .maybeSingle();
                        if (!prodErr && prod) {
                            const current = prod.stock_level || 0;
                            const newStock = Math.max(current - (item.qty || 1), 0);
                            await supabase.from('products').update({ stock_level: newStock }).eq('id', item.productId);
                        }
                    } catch (stockErr) { console.error(stockErr); }
                }

                // Order saved to Supabase; do not also add to localStorage so "My orders" shows it once.

                localStorage.setItem('bragaBazaarCart', '[]');
                document.querySelector('.checkout-container').style.display = 'none';
                const confEl = document.getElementById('orderConfirmation');
                const msgEl = document.getElementById('confirmationMessage');
                if (confEl) confEl.style.display = 'block';
                if (msgEl) {
                    msgEl.innerHTML = 'Encomenda <strong>#' + client_order_id + '</strong>. ' + (fulfillment === 'pickup' ? 'Levantamento na loja' : 'Entrega') + '. Total <strong>€' + total.toFixed(2) + '</strong>. Pode ver as suas encomendas em "As minhas encomendas".';
                }
            } catch (err) {
                console.error(err);
                showCheckoutError(err.message || 'Ocorreu um erro. Tente novamente.');
            } finally {
                isSubmitting = false;
                setSubmitLoading(false);
            }
        });
    </script>
</body>
</html>
